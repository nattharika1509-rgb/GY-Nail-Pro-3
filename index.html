<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จองคิวทำเล็บ | GY - Nail Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Fredoka:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rose: { 50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 300: '#fda4af', 400: '#fb7185', 500: '#f43f5e', 600: '#e11d48', 900: '#881337' }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fff1f2; background-image: radial-gradient(#ffe4e6 1px, transparent 1px); background-size: 20px 20px; padding-bottom: 80px; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="radio"]:checked + div, input[type="radio"]:checked + label { border-color: #f43f5e; background-color: #fff1f2; color: #e11d48; box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.1); }
        input[type="radio"]:checked + label { transform: scale(0.98); }
        input[type="checkbox"]:checked + div { border-color: #f43f5e; background-color: #fff1f2; color: #e11d48; }
        input[type="checkbox"]:checked + div .check-icon { display: block; }
        .time-btn.active { background-color: #f43f5e; color: white; border-color: #f43f5e; box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.3); }
        .price-tag { background-color: #ffe4e6; color: #e11d48; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .price-pop { animation: pop 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .tab-btn { flex: 1; padding-top: 0.75rem; padding-bottom: 0.75rem; text-align: center; color: #fecdd3; cursor: pointer; border-bottom: 4px solid transparent; transition: all; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { color: white; border-color: white; font-weight: 700; background-color: rgba(255,255,255,0.1); border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .cat-tab { padding-left: 1rem; padding-right: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem; border-radius: 9999px; font-size: 0.75rem; cursor: pointer; border: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; }
        .cat-tab.active { background-color: #f43f5e; color: white; border-color: #f43f5e; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(2px); }
        .custom-img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        @media (min-width: 768px) {
            #page-booking form .glass-panel { max-width: 100%; }
            #page-booking .grid.grid-cols-2 { grid-template-columns: repeat(3, 1fr); }
            #slotsContainer { grid-template-columns: repeat(4, 1fr); }
        }
        @media (min-width: 1024px) {
            #page-booking form .glass-panel { max-width: 100%; }
            #page-booking .grid.grid-cols-2 { grid-template-columns: repeat(4, 1fr); }
            #slotsContainer { grid-template-columns: repeat(6, 1fr); }
        }
        #ai-bubble { touch-action: none; transition: none; }
        #ai-bubble.snapping { transition: left 0.3s ease, right 0.3s ease, bottom 0.3s ease; }
        @keyframes aiBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
        @keyframes marquee { 0%{transform:translateX(100%)} 100%{transform:translateX(-100%)} }
        .animate-marquee { animation: marquee 8s linear infinite; white-space: nowrap; }
        #ai-bubble:not(.dragging) > div:first-child { animation: aiBounce 3s ease-in-out infinite; }
        @keyframes contactPop { from { opacity: 0; transform: scale(0) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        #contact-bubble > div:first-child { animation: aiBounce 3s ease-in-out 1.5s infinite; }
    </style>
</head>
<body class="font-sans text-gray-600 min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="text-center p-6 max-w-sm">
            <div id="loader-icon">
                <i class="fas fa-circle-notch fa-spin text-4xl text-rose-500 mb-3"></i>
                <p class="text-rose-400 animate-pulse">กำลังเชื่อมต่อฐานข้อมูล...</p>
            </div>
            <div id="loader-error" class="hidden">
                <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                <p class="text-gray-800 font-bold mb-2">เชื่อมต่อไม่สำเร็จ</p>
                <div class="text-gray-600 mb-4 text-xs text-left bg-gray-100 p-3 rounded border">
                    <b>วิธีแก้ไข:</b><br>
                    1. ตรวจสอบ URL ใน script<br>
                    2. Deploy Google Apps Script ใหม่<br>
                    3. Refresh หน้าเว็บ
                </div>
                <button onclick="location.reload()" class="bg-gray-500 text-white px-6 py-2 rounded-xl shadow hover:bg-gray-600 transition w-full">ลองใหม่</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-rose-400 to-rose-500 text-white shadow-lg sticky top-0 z-50 rounded-b-3xl mb-4">
        <div class="max-w-md md:max-w-2xl lg:max-w-4xl mx-auto px-4 sm:px-6 pt-4 pb-2">
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center space-x-2 flex-1 min-w-0">
                    <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm shrink-0">
                        <i class="fas fa-gem text-lg"></i>
                    </div>
                    <div class="min-w-0">
                        <h1 class="leading-tight" id="shopNameHeader" style="font-family:'Fredoka',sans-serif; font-size:1.5rem; font-weight:700; letter-spacing:2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.15);">GY - NAIL</h1>
                        <p class="text-xs text-rose-100 font-light tracking-wide">จองคิวทำเล็บออนไลน์</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div id="shopStatusBadge" class="hidden">
                        <div id="shopStatusOpen" class="hidden px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1 border border-green-300" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                            <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>
                            เปิด
                        </div>
                        <div id="shopStatusClosed" class="hidden px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1 border border-red-300" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-door-closed text-xs"></i>
                            ปิด
                        </div>
                    </div>
                    <div id="marquee-banner" class="hidden overflow-hidden rounded-full bg-white/20 backdrop-blur-sm py-0.5 px-2 w-32">
                        <div class="overflow-hidden whitespace-nowrap">
                            <span class="inline-block animate-marquee text-white text-[10px] font-medium" id="marquee-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex text-sm font-medium -mx-4 sm:mx-0 border-b border-white/20">
                <div onclick="switchTab('booking')" id="tab-booking" class="tab-btn active">
                    <i class="fas fa-calendar-plus mb-1 block"></i> จองคิว
                </div>
                <div onclick="switchTab('search')" id="tab-search" class="tab-btn">
                    <i class="fas fa-search mb-1 block"></i> เช็กสถานะ
                </div>
                <div onclick="switchTab('admin')" id="tab-admin" class="tab-btn">
                    <i class="fas fa-store mb-1 block"></i> ร้านค้า
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-md md:max-w-2xl lg:max-w-4xl mx-auto w-full px-4 pb-24">
        <!-- BOOKING PAGE -->
        <div id="page-booking" class="fade-in">
            <form id="bookingForm" onsubmit="handleBooking(event)">
                <!-- Quick Actions for Customer -->
                <div class="flex gap-2 mb-4">
                    <button type="button" onclick="document.getElementById('reviews-modal').classList.remove('hidden'); loadReviews();" class="flex-1 bg-gradient-to-r from-yellow-400 to-orange-400 text-white py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-star"></i>
                        <span class="font-medium text-sm">รีวิว</span>
                    </button>
                    <button type="button" onclick="showPortfolioGallery()" class="flex-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-images"></i>
                        <span class="font-medium text-sm">ผลงาน</span>
                    </button>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-sm">
                    <h2 class="text-rose-600 font-semibold mb-4"><i class="fas fa-hand-sparkles mr-2"></i> เลือกแพ็คเกจ</h2>
                    <div class="grid grid-cols-2 gap-3" id="service-list-container">
                        <div class="col-span-2 text-center text-gray-300 py-4">กำลังโหลด...</div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-sm mt-4">
                    <h2 class="text-rose-600 font-semibold mb-2"><i class="fas fa-lightbulb mr-2"></i> ไอเดียลายเล็บ</h2>
                    <div class="grid grid-cols-3 gap-2" id="design-list-container"></div>
                    <div class="mt-3">
                        <label class="block text-sm text-gray-500 mb-1">รายละเอียดเพิ่มเติม</label>
                        <input type="text" id="artInput" name="art" placeholder="เช่น สีแดงเบอร์กัลดี, ลายดอกไม้" class="w-full bg-white border border-gray-200 py-2 px-4 rounded-xl focus:outline-none focus:border-rose-500 text-sm">
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-sm mt-4">
                    <h2 class="text-rose-600 font-semibold mb-4"><i class="fas fa-list-ul mr-2"></i> บริการเสริม & ทรงเล็บ</h2>
                    <div class="mb-5">
                        <label class="block text-sm text-gray-500 mb-2">บริการเสริม (เลือกได้หลายข้อ)</label>
                        <div class="space-y-2" id="addon-list-container"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm text-gray-500 mb-2">ทรงเล็บยอดฮิต</label>
                        <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-4 pt-1 px-1" id="shape-list-container"></div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-sm mt-4">
                    <h2 class="text-rose-600 font-semibold mb-4"><i class="fas fa-map-marker-alt mr-2"></i> สถานที่รับบริการ</h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="cursor-pointer group">
                            <input type="radio" name="locationType" value="ทำที่ร้าน" class="location-radio hidden" checked onchange="toggleAddress(false)">
                            <div class="border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center h-24 transition-all hover:border-rose-300 bg-white text-center">
                                <i class="fas fa-store text-2xl mb-2 text-rose-300"></i>
                                <span class="text-sm font-medium">ทำที่ร้าน</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="locationType" value="ทำที่บ้านลูกค้า" class="location-radio hidden" onchange="toggleAddress(true)">
                            <div class="border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center h-24 transition-all hover:border-rose-300 bg-white text-center">
                                <i class="fas fa-car text-2xl mb-2 text-rose-300"></i>
                                <span class="text-sm font-medium">ทำที่บ้าน</span>
                            </div>
                        </label>
                    </div>
                    <div id="addressField" class="hidden">
                        <label class="block text-sm text-gray-500 mb-1">ที่อยู่ / พิกัด</label>
                        <textarea name="address" rows="2" placeholder="ระบุหมู่บ้าน ซอย ถนน หรือจุดสังเกต..." class="w-full bg-white border border-gray-200 py-2 px-4 rounded-xl focus:outline-none focus:border-rose-500 text-sm"></textarea>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-sm mt-4">
                    <h2 class="text-rose-600 font-semibold mb-4"><i class="far fa-calendar-alt mr-2"></i> วันและเวลา</h2>
                    <div class="mb-4">
                        <input type="date" id="dateInput" name="date" class="w-full text-center bg-white border border-rose-200 text-gray-700 font-medium py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-400 shadow-sm" required>
                    </div>
                    
                    <div id="queueStatus" class="hidden mb-4 bg-gradient-to-r from-rose-50 to-pink-50 rounded-xl p-4 border border-rose-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-rose-700 text-sm"><i class="fas fa-users mr-2"></i>สถานะคิววันนี้</h3>
                            <span class="text-xs text-rose-500 animate-pulse"><i class="fas fa-sync-alt fa-spin mr-1"></i>อัพเดทเรียลไทม์</span>
                        </div>
                        <div id="queueInfo" class="space-y-2"></div>
                        <div class="mt-3 pt-3 border-t border-rose-200">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">จองแล้ว:</span>
                                <span id="bookedCount" class="font-bold text-rose-600">0 คน</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ว่าง:</span>
                                <span id="availableCount" class="font-bold text-green-600">0 คน</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loadingSlots" class="hidden text-center py-4 text-rose-400"><i class="fas fa-circle-notch fa-spin"></i> กำลังเช็คคิวว่าง...</div>
                    <div id="slotsContainer" class="grid grid-cols-3 gap-2 mb-6">
                        <div class="col-span-3 text-center text-gray-400 text-sm py-4 bg-gray-50 rounded-xl border border-dashed border-gray-200">กรุณาเลือกวันที่ก่อน</div>
                    </div>
                    <input type="hidden" name="time" id="selectedTimeInput" required>
                    <div class="border-t border-gray-100 pt-4 space-y-3">
                        <div><label class="text-xs text-gray-400 ml-1">ชื่อเล่น</label><input type="text" name="name" autocomplete="nickname" class="w-full bg-white border border-gray-200 py-3 px-4 rounded-xl focus:outline-none focus:border-rose-500" placeholder="กรอกชื่อเล่น" required></div>
                        <div><label class="text-xs text-gray-400 ml-1">เบอร์โทรศัพท์</label><input type="tel" name="phone" autocomplete="tel" class="w-full bg-white border border-gray-200 py-3 px-4 rounded-xl focus:outline-none focus:border-rose-500" placeholder="0xx-xxx-xxxx" required></div>
                    </div>
                </div>

                <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 p-4 shadow-lg z-40 rounded-t-2xl">
                    <div class="max-w-md md:max-w-2xl lg:max-w-4xl mx-auto flex items-center justify-between gap-4">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-400">ราคาเริ่มต้น</span>
                            <div class="text-xl font-bold text-rose-600 flex items-baseline">
                                <span id="totalPriceDisplay">0</span>
                                <span class="text-sm ml-1 text-gray-500">บาท</span>
                            </div>
                        </div>
                        <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-rose-500 to-rose-400 hover:from-rose-600 hover:to-rose-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2">
                            <span>จองคิว</span>
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- SEARCH PAGE -->
        <div id="page-search" class="hidden fade-in pt-10">
            <div class="glass-panel rounded-2xl p-8 text-center shadow-sm">
                <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-2xl">
                    <i class="fas fa-search"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-700 mb-2">เช็กสถานะการจอง</h2>
                <p class="text-gray-400 text-sm mb-6">กรอกเบอร์โทรศัพท์ หรือ Order ID</p>
                <div class="relative max-w-xs mx-auto">
                    <input type="text" id="search-key" autocomplete="tel" placeholder="08x-xxx-xxxx" class="w-full bg-white border border-gray-200 py-3 px-4 rounded-xl focus:outline-none focus:border-rose-500 text-center">
                    <button onclick="doSearch()" class="absolute right-2 top-2 bg-rose-500 text-white w-8 h-8 rounded-lg hover:bg-rose-600 transition"><i class="fas fa-arrow-right"></i></button>
                </div>
                <div id="search-result" class="mt-6 hidden text-left space-y-4"></div>
                <div id="search-error" class="mt-4 text-red-400 text-sm hidden">ไม่พบข้อมูลการจอง</div>
            </div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="page-admin" class="hidden fade-in pt-10">
            <div id="admin-login" class="glass-panel rounded-2xl p-8 text-center shadow-sm max-w-xs mx-auto">
                <i class="fas fa-lock text-3xl text-gray-300 mb-4"></i>
                <h2 class="text-lg font-bold text-gray-700 mb-4">เข้าสู่ระบบร้านค้า</h2>
                <input type="password" id="admin-pass" placeholder="รหัสผ่าน" class="w-full bg-white border border-gray-200 py-2 px-4 rounded-xl mb-3 text-center focus:outline-none focus:border-rose-500">
                <button onclick="doLogin()" class="w-full bg-gray-800 text-white py-2 rounded-xl hover:bg-gray-700 transition">Login</button>
            </div>

            <div id="admin-dash" class="hidden">
                <!-- Error Message Container -->
                <div id="admin-dash-error" class="hidden mb-4 p-3 bg-red-100 border border-red-200 text-red-600 rounded-xl text-sm flex items-center justify-center">
                </div>

                <!-- Revenue Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div class="glass-panel rounded-xl p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">วันนี้</p>
                        <p class="text-lg font-bold text-rose-500" id="today-revenue">฿0</p>
                    </div>
                    <div class="glass-panel rounded-xl p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">เดือนนี้</p>
                        <p class="text-lg font-bold text-green-500" id="month-revenue">฿0</p>
                    </div>
                    <div class="glass-panel rounded-xl p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">ทั้งหมด</p>
                        <p class="text-lg font-bold text-blue-500" id="total-revenue">฿0</p>
                    </div>
                    <div class="glass-panel rounded-xl p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">รออนุมัติ</p>
                        <p class="text-lg font-bold text-orange-500" id="pending-count">0</p>
                    </div>
                </div>

                <!-- New Analytics Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- 7-Day Chart -->
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-chart-line text-rose-500"></i> สถิติ 7 วันย้อนหลัง
                        </h3>
                        <div id="admin-revenue-chart" class="h-32 flex items-end justify-between px-2 gap-1 border-b border-gray-100 pb-2">
                            <!-- Chart Bars will be injected here -->
                        </div>
                    </div>

                    <!-- Top Services -->
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-fire text-orange-500"></i> 5 อันดับบริการยอดนิยม
                        </h3>
                        <div id="top-services-list" class="space-y-2 text-sm">
                            <!-- Services will be injected here -->
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-4 shadow-sm mb-4 bg-gray-800 text-white flex flex-col sm:flex-row justify-between items-center sticky top-20 z-40 gap-2">
                    <h2 class="font-bold text-lg"><i class="fas fa-columns mr-2"></i>จัดการร้านค้า</h2>
                    <div class="space-x-2 flex">
                        <button onclick="showPendingApprovals()" class="text-xs bg-orange-500 px-3 py-2 rounded-lg hover:bg-orange-600 font-medium relative">
                            <i class="fas fa-clock mr-1"></i> รออนุมัติ
                            <span id="pending-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center">0</span>
                        </button>
                        <button onclick="openServiceManager('services')" class="text-xs bg-rose-500 px-3 py-2 rounded-lg hover:bg-rose-600 font-medium"><i class="fas fa-list mr-1"></i> เมนู</button>
                        <button onclick="showSettingsModal()" class="text-xs bg-gray-700 px-3 py-2 rounded-lg hover:bg-gray-600 border border-gray-600"><i class="fas fa-cog mr-1"></i> ตั้งค่า</button>
                        <button onclick="adminLogout()" class="text-xs bg-red-500 px-3 py-2 rounded-lg hover:bg-red-600"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4 px-1">
                    <h3 class="font-bold text-gray-700">รายการจองล่าสุด</h3>
                    <button onclick="loadAdminData()" class="text-rose-500 text-sm hover:underline"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
                </div>

  

                <div class="glass-panel rounded-xl p-4 mb-4">
                    <h3 class="font-bold text-gray-700 mb-3">เมนูด่วน</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="showCustomersPage()" class="bg-blue-100 text-blue-600 py-2 rounded-lg text-xs font-medium"><i class="fas fa-users mb-1 block"></i>ลูกค้า</button>
                        <button onclick="showReportsPage()" class="bg-green-100 text-green-600 py-2 rounded-lg text-xs font-medium"><i class="fas fa-chart-bar mb-1 block"></i>รายงาน</button>
                        <button onclick="openServiceManager('services')" class="bg-rose-100 text-rose-600 py-2 rounded-lg text-xs font-medium"><i class="fas fa-list mb-1 block"></i>เมนู</button>
                    </div>
                </div>

                <!-- Google Sheet Shortcuts -->
                <div class="glass-panel rounded-xl p-4 mb-4">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-external-link-alt text-green-500"></i> ทางลัด Google Sheets
                    </h3>
                    <div class="space-y-2">
                        <a href="https://docs.google.com/spreadsheets/d/1BJq47HiG2iaBA5HegYKSAMqfSy7fqKeQxe_7ZLQemX0/edit?usp=sharing" target="_blank" class="flex items-center justify-between bg-green-50 p-3 rounded-lg hover:bg-green-100 transition">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-table text-green-600"></i>
                                <span class="text-sm text-gray-700">จัดการข้อมูล (Google Sheets)</span>
                            </div>
                            <i class="fas fa-external-link-alt text-gray-400 text-xs"></i>
                        </a>
                        <button onclick="showReviewManagement()" class="w-full flex items-center justify-between bg-yellow-50 p-3 rounded-lg hover:bg-yellow-100 transition">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-star text-yellow-500"></i>
                                <span class="text-sm text-gray-700">จัดการรีวิว</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </button>
                        <button onclick="showPortfolioManager()" class="w-full flex items-center justify-between bg-purple-50 p-3 rounded-lg hover:bg-purple-100 transition">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-images text-purple-500"></i>
                                <span class="text-sm text-gray-700">จัดการผลงาน / Gallery</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </button>
                        <button onclick="openDriveFolder()" class="w-full flex items-center justify-between bg-blue-50 p-3 rounded-lg hover:bg-blue-100 transition">
                            <div class="flex items-center gap-2">
                                <i class="fab fa-google-drive text-blue-500"></i>
                                <span class="text-sm text-gray-700">เปิด Google Drive ร้าน</span>
                            </div>
                            <i class="fas fa-external-link-alt text-gray-400 text-xs"></i>
                        </button>
                        <button onclick="toggleAIChat()" class="w-full flex items-center justify-between bg-rose-50 p-3 rounded-lg hover:bg-rose-100 transition">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-robot text-rose-500"></i>
                                <span class="text-sm text-gray-700">ทดสอบน้องยุ้ย AI</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-store text-rose-500"></i> สถานะร้าน</h3>
                        <div id="shopStatusAdminBadge" class="px-3 py-1 rounded-full text-xs font-bold">กำลังโหลด...</div>
                    </div>
                    <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">เปิด/ปิดรับจอง</p>
                            <p class="text-xs text-gray-400">ลูกค้าจะเห็นสถานะนี้บนหน้าเว็บ</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="shopStatusToggle" class="sr-only peer" onchange="toggleShopStatus()">
                            <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-rose-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-rose-500"></div>
                        </label>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <button onclick="showShopScheduleModal()" class="w-full py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <i class="fas fa-calendar-alt"></i> ตั้งค่าตารางเปิด/ปิดร้าน
                        </button>
                    </div>
                </div>
                <div id="booking-list" class="space-y-3 pb-24"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800">ตั้งค่าร้านค้า</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="settings-form" class="space-y-3"></div>
            <button onclick="saveSettings()" class="w-full bg-rose-500 text-white py-2 rounded-xl mt-4 hover:bg-rose-600">บันทึก</button>
        </div>
    </div>

    <div id="shop-schedule-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-calendar-week text-rose-500"></i> ตั้งค่าตารางเปิด/ปิดร้าน</h3>
                <button onclick="closeModal('shop-schedule-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-rose-50 p-3 rounded-lg text-sm text-rose-700"><i class="fas fa-info-circle mr-1"></i> ตั้งค่าวันที่ร้านปิดหรือเปิดเป็นพิเศษ</div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">วันที่กำหนดไว้</h4>
                    <div id="specialDatesList" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-4">ไม่มีวันที่กำหนดไว้</p>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-3">เพิ่มวันพิเศษ</h4>
                    <div class="space-y-3">
                        <div><label class="text-xs text-gray-500 block mb-1">วันที่</label><input type="date" id="specialDateInput" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm"></div>
                        <div><label class="text-xs text-gray-500 block mb-1">สถานะ</label>
                            <select id="specialDateStatus" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                                <option value="closed">ปิดร้าน</option>
                                <option value="open">เปิดร้าน (พิเศษ)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-500 block mb-1">หมายเหตุ</label><input type="text" id="specialDateNote" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="เช่น วันหยุดนักขัตฤกษ์"></div>
                        <button onclick="addSpecialDate()" class="w-full bg-rose-500 text-white py-2 rounded-lg text-sm hover:bg-rose-600"><i class="fas fa-plus mr-1"></i> เพิ่ม</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="service-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] flex flex-col h-[600px]">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg text-gray-800">จัดการเมนู</h3>
                <button onclick="closeServiceManager()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-2">
                <button onclick="switchManagerTab('services')" id="mgr-tab-services" class="cat-tab active">บริการหลัก</button>
                <button onclick="switchManagerTab('designs')" id="mgr-tab-designs" class="cat-tab">ไอเดียลายเล็บ</button>
                <button onclick="switchManagerTab('addons')" id="mgr-tab-addons" class="cat-tab">บริการเสริม</button>
                <button onclick="switchManagerTab('shapes')" id="mgr-tab-shapes" class="cat-tab">ทรงเล็บ</button>
            </div>
            <div class="overflow-y-auto flex-1 space-y-2 mb-4 p-1" id="admin-service-list"></div>
            <button onclick="openServiceEdit()" class="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600"><i class="fas fa-plus mr-1"></i> เพิ่มรายการใหม่</button>
        </div>
    </div>

    <div id="service-edit-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg text-gray-800 mb-4" id="svc-form-title">เพิ่ม/แก้ไข</h3>
            <div class="space-y-3">
                <input type="hidden" id="svc-id">
                <div><label class="text-xs text-gray-500 block mb-1">ชื่อรายการ</label><input type="text" id="svc-name" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-rose-500 outline-none"></div>
                <div id="field-price-container"><label class="text-xs text-gray-500 block mb-1">ราคา (ใส่ 0 ถ้าฟรี)</label><input type="number" id="svc-price" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-rose-500 outline-none"></div>
                <div id="field-icon-container"><label class="text-xs text-gray-500 block mb-1">ไอคอน / URL รูปภาพ</label><input type="text" id="svc-icon" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-rose-500 outline-none" placeholder="fas fa-star หรือ https://..."></div>
            </div>
            <div class="flex gap-2 mt-5">
                <button onclick="closeModal('service-edit-modal')" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded-xl">ยกเลิก</button>
                <button onclick="saveServiceData()" class="flex-1 bg-rose-500 text-white py-2 rounded-xl hover:bg-rose-600">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800">ข้อมูลลูกค้า</h3>
                <button onclick="closeModal('customer-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="customer-detail-content" class="space-y-4"></div>
        </div>
    </div>

    <div id="reports-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800">รายงานรายได้</h3>
                <button onclick="closeModal('reports-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <button onclick="loadRevenueReport('today')" class="flex-1 py-2 text-sm bg-rose-500 text-white rounded-lg">วันนี้</button>
                    <button onclick="loadRevenueReport('week')" class="flex-1 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg">สัปดาห์</button>
                    <button onclick="loadRevenueReport('month')" class="flex-1 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg">เดือน</button>
                </div>
                <div id="revenue-chart" class="h-48 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-400 text-sm">เลือกช่วงเวลาเพื่อดูรายงาน</p></div>
                <div id="revenue-summary" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Portfolio Gallery Modal -->
    <div id="portfolio-modal" class="fixed inset-0 bg-black/50 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="font-bold text-gray-800"><i class="fas fa-images text-purple-500 mr-2"></i>ผลงานของเรา</h3>
                <button onclick="closeModal('portfolio-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="portfolio-upload-section" class="hidden p-4 border-b bg-purple-50">
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 mb-1 block">เลือกรูป</label>
                        <input type="file" id="portfolio-file" accept="image/*" class="w-full text-xs border rounded-lg p-1.5">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 mb-1 block">คำอธิบาย</label>
                        <input type="text" id="portfolio-caption" placeholder="เช่น เล็บเจลลายดอกไม้" class="w-full text-sm border rounded-lg px-3 py-1.5">
                    </div>
                </div>
                <div class="flex gap-2 mt-2">
                    <select id="portfolio-category" class="text-sm border rounded-lg px-3 py-1.5 flex-1">
                        <option value="">หมวดหมู่</option>
                        <option value="เจล">เจล</option>
                        <option value="อะคริลิค">อะคริลิค</option>
                        <option value="เพ้นท์">เพ้นท์</option>
                        <option value="ต่อเล็บ">ต่อเล็บ</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                    <button onclick="uploadPortfolioImage()" id="upload-btn" class="bg-purple-500 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-purple-600">
                        <i class="fas fa-upload mr-1"></i> อัพโหลด
                    </button>
                </div>
            </div>
            <div id="portfolio-grid" class="flex-1 overflow-y-auto p-4">
                <div class="text-center text-gray-400 py-10"><i class="fas fa-circle-notch fa-spin"></i> กำลังโหลด...</div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black/80 hidden z-[90] flex items-center justify-center p-4" onclick="closeModal('image-preview-modal')">
        <img id="preview-image" src="" class="max-w-full max-h-[85vh] rounded-xl shadow-2xl">
    </div>

    <!-- Contact Floating Bubble -->
    <div id="contact-bubble" class="fixed z-[79] select-none" style="bottom:100px;left:20px;">
        <div id="contact-menu" class="hidden absolute bottom-[70px] left-0 flex flex-col-reverse gap-2 sm:gap-3 items-center" style="transform: translateX(-20%);">
            <a id="contact-facebook" href="#" target="_blank" class="w-10 h-10 sm:w-12 sm:h-12 bg-[#1877F2] rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-transform" style="animation: contactPop 0.3s ease forwards; animation-delay: 0.08s; opacity: 0;">
                <i class="fab fa-facebook-f text-white text-base sm:text-lg"></i>
            </a>
            <a id="contact-tiktok" href="#" target="_blank" class="w-10 h-10 sm:w-12 sm:h-12 bg-black rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-transform" style="animation: contactPop 0.3s ease forwards; animation-delay: 0.16s; opacity: 0;">
                <i class="fab fa-tiktok text-white text-base sm:text-lg"></i>
            </a>
            <a id="contact-phone" href="tel:" class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-transform" style="animation: contactPop 0.3s ease forwards; animation-delay: 0.24s; opacity: 0;">
                <i class="fas fa-phone-alt text-white text-base sm:text-lg"></i>
            </a>
        </div>
        <div onclick="toggleContactMenu()" class="relative w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full shadow-xl flex items-center justify-center hover:scale-110 transition-transform cursor-pointer transition-all duration-300" style="transform: rotate(-90deg);">
            <i class="fas fa-headset text-white text-lg sm:text-2xl"></i>
        </div>
        <div class="text-center mt-0.5 sm:mt-1">
            <span class="text-[9px] sm:text-[10px] text-blue-500 font-medium bg-white/80 px-1.5 sm:px-2 py-0.5 rounded-full shadow-sm">ติดต่อ</span>
        </div>
    </div>

    <!-- AI Floating Bubble -->
    <div id="ai-bubble" class="fixed z-[80] cursor-grab active:cursor-grabbing select-none" style="bottom:100px;right:20px;" ontouchstart="aiBubbleTouchStart(event)" ontouchmove="aiBubbleTouchMove(event)" ontouchend="aiBubbleTouchEnd(event)" onmousedown="aiBubbleMouseDown(event)">
        <div onclick="toggleAIChat()" class="relative w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-rose-500 to-pink-500 rounded-full shadow-xl flex items-center justify-center hover:scale-110 transition-transform">
            <i class="fas fa-robot text-white text-xl sm:text-2xl"></i>
            <div id="ai-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center animate-pulse">
                <span class="text-white text-[10px] font-bold" id="ai-badge-count">0</span>
            </div>
        </div>
        <div class="text-center mt-1">
            <span class="text-[10px] text-rose-500 font-medium bg-white/80 px-2 py-0.5 rounded-full shadow-sm">น้องยุ้ย</span>
        </div>
    </div>

    <!-- AI Chat Panel -->
    <div id="ai-panel" class="fixed z-[81] hidden" style="bottom:170px;right:10px;">
        <div class="bg-white w-[calc(100vw-20px)] max-w-sm sm:w-96 rounded-2xl shadow-2xl flex flex-col border border-rose-100" style="height:min(70vh,500px);">
            <div class="flex justify-between items-center p-3 border-b bg-gradient-to-r from-rose-500 to-pink-500 text-white rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">น้องยุ้ยคนสวย</h3>
                        <p class="text-[10px] text-rose-100">ผู้ช่วยปรึกษาเรื่องเล็บ</p>
                    </div>
                </div>
                <button onclick="toggleAIChat()" class="text-white/80 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10"><i class="fas fa-chevron-down"></i></button>
            </div>
            
            <div id="ai-chat-container" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50">
                <div class="flex gap-2">
                    <div class="w-7 h-7 bg-rose-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-[10px]"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">
                        <p class="text-sm text-gray-700">สวัสดีค่ะ น้องยุ้ยเองนะคะ 💅<br><br>มีอะไรให้ช่วยเรื่องทำเล็บไหมคะ?
                        <br>• เล็บแห้ง/เปราะ แก้ยังไง?
                        <br>• แนะนำลาย/ดีไซน์
                        <br>• เคล็ดลับดูแลเล็บ
                        <br><br>ถามมาได้เลยค่ะ!</p>
                    </div>
                </div>
            </div>
            
            <div class="p-3 border-t bg-white rounded-b-2xl">
                <div class="flex gap-1.5 mb-2 overflow-x-auto no-scrollbar">
                    <button onclick="setAIContext('dry')" class="text-[11px] bg-orange-100 text-orange-600 px-2.5 py-1 rounded-full hover:bg-orange-200 whitespace-nowrap flex-shrink-0">เล็บแห้ง/เปราะ</button>
                    <button onclick="setAIContext('design')" class="text-[11px] bg-pink-100 text-pink-600 px-2.5 py-1 rounded-full hover:bg-pink-200 whitespace-nowrap flex-shrink-0">แนะนำลาย</button>
                    <button onclick="setAIContext('care')" class="text-[11px] bg-green-100 text-green-600 px-2.5 py-1 rounded-full hover:bg-green-200 whitespace-nowrap flex-shrink-0">วิธีดูแลเล็บ</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="ai-input" placeholder="พิมพ์คำถาม..." class="flex-1 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-rose-500" onkeypress="if(event.key==='Enter')sendAIMessage()">
                    <button onclick="sendAIMessage()" class="bg-rose-500 text-white w-9 h-9 rounded-xl hover:bg-rose-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Modal -->
    <div id="reviews-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i> รีวิวจากลูกค้า
                </h3>
                <button onclick="closeModal('reviews-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl mb-4">
                <div class="text-center">
                    <div class="text-4xl font-bold text-yellow-500" id="avg-rating">0.0</div>
                    <div class="flex justify-center gap-1 my-2" id="avg-stars"></div>
                    <p class="text-sm text-gray-600">จาก <span id="total-reviews">0</span> รีวิว</p>
                </div>
            </div>
            
            <div id="reviews-list" class="space-y-3">
                <p class="text-gray-400 text-center py-4">กำลังโหลดรีวิว...</p>
            </div>
            
            <div class="mt-4 pt-4 border-t">
                <button onclick="showSubmitReview()" class="w-full bg-rose-500 text-white py-2 rounded-xl hover:bg-rose-600">
                    <i class="fas fa-pen mr-2"></i>เขียนรีวิว
                </button>
            </div>
        </div>
    </div>

    <!-- Submit Review Modal -->
    <div id="submit-review-modal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-gray-800">เขียนรีวิว</h3>
                <button onclick="closeModal('submit-review-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-600 block mb-2">รหัสการจอง (Order ID)</label>
                    <input type="text" id="review-order-id" placeholder="เช่น GY-0123456789" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="text-sm text-gray-600 block mb-2">ให้คะแนน</label>
                    <div class="flex justify-center gap-2" id="star-rating">
                        <button onclick="setRating(1)" class="text-3xl text-gray-300 hover:text-yellow-400 transition star-btn" data-rating="1"><i class="fas fa-star"></i></button>
                        <button onclick="setRating(2)" class="text-3xl text-gray-300 hover:text-yellow-400 transition star-btn" data-rating="2"><i class="fas fa-star"></i></button>
                        <button onclick="setRating(3)" class="text-3xl text-gray-300 hover:text-yellow-400 transition star-btn" data-rating="3"><i class="fas fa-star"></i></button>
                        <button onclick="setRating(4)" class="text-3xl text-gray-300 hover:text-yellow-400 transition star-btn" data-rating="4"><i class="fas fa-star"></i></button>
                        <button onclick="setRating(5)" class="text-3xl text-gray-300 hover:text-yellow-400 transition star-btn" data-rating="5"><i class="fas fa-star"></i></button>
                    </div>
                    <input type="hidden" id="review-rating" value="0">
                </div>
                <div>
                    <label class="text-sm text-gray-600 block mb-2">ความคิดเห็น</label>
                    <textarea id="review-text" rows="3" placeholder="บอกเล่าประสบการณ์การใช้บริการ..." class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm text-gray-600 block mb-2">แนบรูปผลงาน (ไม่บังคับ)</label>
                    <input type="file" id="review-image" accept="image/*" class="w-full text-xs border rounded-lg p-1.5">
                </div>
                <button onclick="submitReview()" class="w-full bg-yellow-500 text-white py-2 rounded-xl hover:bg-yellow-600 font-medium">
                    ส่งรีวิว
                </button>
            </div>
        </div>
    </div>

    <div id="slip-modal" class="fixed inset-0 bg-black/80 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-gray-800">หลักฐานการโอน</h3>
                <button onclick="closeModal('slip-modal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <img id="slip-image" class="w-full rounded-lg mb-4" src="" alt="Payment Slip">
            <div class="flex gap-2">
                <button onclick="approveWithSlip()" class="flex-1 bg-green-500 text-white py-2 rounded-xl font-medium">อนุมัติ</button>
                <button onclick="rejectWithSlip()" class="flex-1 bg-red-500 text-white py-2 rounded-xl font-medium">ปฏิเสธ</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// GY-Nail Frontend - Inline JavaScript
// ============================================

// ⚠️ เปลี่ยน URL นี้เป็น Web App URL ที่ได้จากการ Deploy Google Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbwL-0iETENspSTzsO02z-WaH6zmTiF5B0csH7YS9FFFxy3pHAPTgCj9EwEwFy0Wt0MU/exec";

let settings = {}; 
let bookings = [];
let menuData = { services: [], designs: [], addons: [], shapes: [] }; 
let currentManagerTab = 'services';
let shopStatus = { isOpen: true, specialDates: [] };
let queueRefreshInterval = null;
let lastQueueData = null;
let currentSlipRow = null;

const defaultMenu = {
    services: [
        {id:'s1', name:'ทาสีเจล (สีพื้น)', price:150, icon:'fas fa-paint-brush'},
        {id:'s2', name:'ทาสีเจล (ลูกแก้ว)', price:200, icon:'fas fa-magic'},
        {id:'s3', name:'ต่อ PVC (สีพื้น)', price:250, icon:'fas fa-hand-holding-heart'}
    ],
    designs: [
        {id:'d1', name:'Minimal', icon:'fas fa-seedling'},
        {id:'d2', name:'Luxury', icon:'fas fa-crown'},
        {id:'d3', name:'Y2K', icon:'fas fa-star'}
    ],
    addons: [
        {id:'a1', name:'เสริมหน้าเล็บ (Overlay)', price:80},
        {id:'a2', name:'ถอดเล็บเดิม', price:100}
    ],
    shapes: [
        {id:'sh1', name:'Almond', icon:'🌰'},
        {id:'sh2', name:'Oval', icon:'🥚'},
        {id:'sh3', name:'Square', icon:'🟩'}
    ]
};

// API Functions
const apiCall = (action, params, onSuccess, onFailure) => {
    // ใช้ POST ทั้งหมดเพื่อเลี่ยงปัญหา CORS และ URL ยาวเกินไป
    const payload = {
        action: action,
        ...params
    };

    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
            "Content-Type": "text/plain;charset=utf-8"
        },
        redirect: "follow"
    })
    .then(r => r.json())
    .then(data => {
        if(data.status === 'error' && !data.bookings) {
            if(onFailure) onFailure(data.message);
            else Swal.fire('Error', data.message || 'System Error', 'error');
        } else {
            if(onSuccess) onSuccess(data);
        }
    })
    .catch(e => {
        console.error(`Fetch failed for ${action}`, e);
        if(action === 'getPublicSettings') {
            document.getElementById('loader-icon').classList.add('hidden');
            document.getElementById('loader-error').classList.remove('hidden');
        } else {
            Swal.fire({ icon: 'error', title: 'การเชื่อมต่อขัดข้อง', text: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้ หรือกรุณาตรวจสอบการตั้งค่า CORS', confirmButtonColor: '#f43f5e' });
            if (onFailure) onFailure("Connection failed");
        }
    });
};

const googleScriptRun = {
    getPublicSettings: (s, f) => apiCall('getPublicSettings', {}, s, f),
    getBookedSlots: (d, s) => apiCall('getBookedSlots', {date: d}, s),
    submitBooking: (d, s, f) => apiCall('submitBooking', d, s, f),
    searchBooking: (k, s) => apiCall('searchBooking', {key: k}, s),
    adminLogin: (p, s) => apiCall('adminLogin', {pass: p}, s),
    getAdminData: (s) => apiCall('getAdminData', {}, s),
    updateBookingStatus: (r, st, s) => apiCall('updateBookingStatus', {rowIndex: r, status: st}, s),
    deleteBooking: (r, s) => apiCall('deleteBooking', {rowIndex: r}, s),
    saveSettings: (st, s) => apiCall('saveSettings', {settings: st}, s)
};

// Init
window.onload = function() {
    if (API_URL === "YOUR_WEB_APP_URL_HERE") {
        document.getElementById('loader-icon').classList.add('hidden');
        document.getElementById('loader-error').classList.remove('hidden');
        return;
    }
    
    googleScriptRun.getPublicSettings(data => {
        initSuccess(data);
    });
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').min = today;
    loadShopStatus();
};

function initSuccess(data) {
    settings = data;
    if(settings.shopName) document.getElementById('shopNameHeader').innerText = settings.shopName;
    
    loadContactChannels();
    initSnowfall();
    
    if (settings.marqueeText) {
        const banner = document.getElementById('marquee-banner');
        document.getElementById('marquee-text').innerText = settings.marqueeText;
        banner.classList.remove('hidden');
    }
    
    if (settings.menu_config && settings.menu_config !== "") {
        try { menuData = JSON.parse(settings.menu_config); } 
        catch(e) { menuData = defaultMenu; }
    } else {
        menuData = defaultMenu;
    }
    
    ['services', 'designs', 'addons', 'shapes'].forEach(k => {
        if(!menuData[k]) menuData[k] = [];
    });

    renderAllSections();
    document.getElementById('loading').classList.add('hidden');
}

function renderAllSections() {
    renderServices();
    renderDesigns();
    renderAddons();
    renderShapes();
    calculateTotal();
}

function renderServices() {
    const container = document.getElementById('service-list-container');
    container.innerHTML = '';
    if(menuData.services.length === 0) container.innerHTML = '<div class="col-span-2 text-center text-gray-300">ยังไม่มีบริการ</div>';
    
    menuData.services.forEach((s, index) => {
        const isChecked = index === 0 ? 'checked' : '';
        let iconDisplay = s.icon && (s.icon.startsWith('http') || s.icon.startsWith('data:')) 
            ? `<img src="${s.icon}" class="w-16 h-16 object-cover rounded-lg mb-2 shadow-sm">` 
            : `<i class="${s.icon || 'fas fa-star'} text-2xl mb-2 text-rose-300"></i>`;

        container.innerHTML += `
            <label class="cursor-pointer group">
                <input type="radio" name="service" value="${s.name}" data-price="${s.price}" class="service-radio hidden" ${isChecked} onchange="calculateTotal()">
                <div class="border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center h-full min-h-[9rem] transition-all hover:border-rose-300 bg-white text-center">
                    ${iconDisplay}
                    <span class="text-sm font-medium leading-tight mb-1">${s.name}</span>
                    <span class="price-tag">เริ่มต้น ${s.price}.-</span>
                </div>
            </label>
        `;
    });
}

function renderDesigns() {
    const container = document.getElementById('design-list-container');
    container.innerHTML = '';
    menuData.designs.forEach((d) => {
        let iconDisplay = d.icon && (d.icon.startsWith('http') || d.icon.startsWith('data:')) 
            ? `<img src="${d.icon}" class="w-8 h-8 object-cover rounded-full mb-1">` 
            : `<div class="bg-rose-50 rounded-full w-8 h-8 flex items-center justify-center mb-1 text-rose-400"><i class="${d.icon || 'fas fa-star'}"></i></div>`;

        container.innerHTML += `
            <div class="relative">
                <input type="radio" name="design_select" id="d_${d.id}" class="design-radio hidden" onclick="fillDesign('${d.name}')">
                <label for="d_${d.id}" class="block border border-gray-200 bg-white rounded-lg p-3 text-center cursor-pointer transition-all h-full flex flex-col justify-center items-center">
                    ${iconDisplay}
                    <span class="text-xs font-medium">${d.name}</span>
                    <div class="check-icon hidden absolute top-1 right-1 text-rose-500 text-xs"><i class="fas fa-check-circle"></i></div>
                </label>
            </div>
        `;
    });
}

function renderAddons() {
    const container = document.getElementById('addon-list-container');
    container.innerHTML = '';
    menuData.addons.forEach((a) => {
        container.innerHTML += `
            <label class="block cursor-pointer">
                <input type="checkbox" class="addon-checkbox hidden" value="${a.name}" data-price="${a.price}" onchange="calculateTotal()">
                <div class="border border-gray-200 bg-white rounded-xl p-3 flex justify-between items-center hover:border-rose-300 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded border border-gray-300 flex items-center justify-center text-white bg-white"><i class="fas fa-check text-xs hidden check-icon"></i></div>
                        <span class="text-sm text-gray-700">${a.name}</span>
                    </div>
                    <span class="text-xs font-bold text-rose-500">+${a.price}.-</span>
                </div>
            </label>
        `;
    });
}

function renderShapes() {
    const container = document.getElementById('shape-list-container');
    container.innerHTML = '';
    menuData.shapes.forEach((sh, idx) => {
        const isChecked = idx === 0 ? 'checked' : '';
        let iconDisplay = sh.icon && (sh.icon.startsWith('http') || sh.icon.startsWith('data:')) 
            ? `<img src="${sh.icon}" class="w-8 h-8 object-cover mb-1">` 
            : `<div class="text-2xl mb-1">${sh.icon || '💅'}</div>`;

        container.innerHTML += `
            <div class="flex-shrink-0">
                <input type="radio" name="shape" id="sh_${sh.id}" value="${sh.name}" class="hidden shape-radio" ${isChecked}>
                <label for="sh_${sh.id}" class="border bg-white rounded-lg px-3 py-3 text-center block cursor-pointer transition border-gray-200 min-w-[75px]">
                    ${iconDisplay}
                    <div class="text-[11px] font-medium text-gray-600">${sh.name}</div>
                </label>
            </div>
        `;
    });
}

function fillDesign(txt) {
    const input = document.getElementById('artInput');
    input.value = input.value.includes(txt) ? input.value : (input.value ? txt + ", " + input.value : txt);
    input.classList.add('bg-rose-50', 'border-rose-300');
    setTimeout(() => input.classList.remove('bg-rose-50', 'border-rose-300'), 500);
}

function toggleAddress(show) {
    const field = document.getElementById('addressField');
    if(show) { field.classList.remove('hidden'); field.querySelector('textarea').required = true; }
    else { field.classList.add('hidden'); field.querySelector('textarea').required = false; }
}

function calculateTotal() {
    let total = 0;
    const s = document.querySelector('input[name="service"]:checked'); 
    if(s) total += parseInt(s.dataset.price||0);
    document.querySelectorAll('.addon-checkbox:checked').forEach(cb => {
        total += parseInt(cb.dataset.price||0);
    });
    const d = document.getElementById('totalPriceDisplay');
    d.textContent = total.toLocaleString();
    d.classList.remove('price-pop'); void d.offsetWidth; d.classList.add('price-pop');
}

// Calendar & Slots
document.getElementById('dateInput').addEventListener('change', function() { 
    if(this.value) {
        fetchAvailableSlots(this.value);
        startQueueRefresh(this.value);
    }
});

function fetchAvailableSlots(dateStr) {
    document.getElementById('slotsContainer').classList.add('hidden'); 
    document.getElementById('loadingSlots').classList.remove('hidden'); 
    document.getElementById('selectedTimeInput').value = '';
    googleScriptRun.getBookedSlots(dateStr, res => {
        document.getElementById('loadingSlots').classList.add('hidden'); 
        document.getElementById('slotsContainer').classList.remove('hidden');

        if (res.shopStatus === 'closed') {
            const container = document.getElementById('slotsContainer');
            container.innerHTML = `
                <div class="col-span-3 text-center py-6 bg-red-50 rounded-xl border border-red-200">
                    <i class="fas fa-store-slash text-3xl text-red-400 mb-2"></i>
                    <p class="text-red-600 font-bold">${res.shopMessage || 'ร้านปิดในวันนี้'}</p>
                    <p class="text-red-400 text-sm mt-1">กรุณาเลือกวันอื่น</p>
                </div>`;
            return;
        }

        renderSlots(res.booked || [], res.serverDate, res.serverTime, dateStr);
    });
}

function renderSlots(booked, serverDate, serverTime, selectedDate) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    const slots = (settings.timeSlots || "10:00,11:30,13:00,14:30,16:00,17:30").split(',').map(s=>s.trim());
    
    const isToday = (selectedDate === serverDate);

    const bookedMap = {};
    booked.forEach(b => {
        bookedMap[b.time] = { status: b.status, orderId: b.orderId };
    });

    let availableCount = 0;

    slots.forEach(t => {
        const time = t.trim();
        const btn = document.createElement('button'); 
        btn.type = 'button'; 

        if (isToday && time <= serverTime) {
            btn.disabled = true;
            btn.className = 'py-3 rounded-xl text-sm bg-gray-100 text-gray-300 cursor-not-allowed border border-gray-200 line-through';
            btn.innerHTML = `${time} <span class="text-[10px] block">ผ่านแล้ว</span>`;
        } else if(bookedMap[time]) {
            const bookingInfo = bookedMap[time];
            btn.disabled = true;
            
            if (bookingInfo.status === 'ยืนยันแล้ว' || bookingInfo.status === 'กำลังให้บริการ' || bookingInfo.status === 'เสร็จสิ้น') {
                btn.className = 'py-3 rounded-xl text-sm bg-red-100 text-red-400 cursor-not-allowed border border-red-200';
                btn.innerHTML = `${time} <i class="fas fa-lock text-xs ml-1"></i>`;
            } else if (bookingInfo.status === 'แจ้งชำระแล้ว' || bookingInfo.status === 'รอชำระเงิน') {
                btn.className = 'py-3 rounded-xl text-sm bg-orange-100 text-orange-500 cursor-not-allowed border border-orange-200';
                btn.innerHTML = `${time} <i class="fas fa-clock text-xs ml-1"></i>`;
            } else {
                btn.className = 'py-3 rounded-xl text-sm bg-gray-100 text-gray-400 cursor-not-allowed';
                btn.textContent = time;
            }
        } else {
            availableCount++;
            btn.className = 'time-btn py-3 rounded-xl text-sm bg-white text-gray-600 border border-rose-100 hover:border-rose-400 hover:text-rose-500 transition shadow-sm font-medium';
            btn.textContent = time;
            btn.onclick = () => { 
                document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active')); 
                btn.classList.add('active'); 
                document.getElementById('selectedTimeInput').value = time; 
            };
        }
        container.appendChild(btn);
    });

    if (availableCount === 0) {
        const msg = document.createElement('div');
        msg.className = 'col-span-3 text-center py-4 bg-yellow-50 rounded-xl border border-yellow-200 mt-2';
        msg.innerHTML = '<i class="fas fa-exclamation-circle text-yellow-500 mr-1"></i> <span class="text-yellow-700 text-sm font-medium">คิวเต็มทุกรอบ กรุณาเลือกวันอื่น</span>';
        container.appendChild(msg);
    }
    
    const legend = document.createElement('div');
    legend.className = 'col-span-3 mt-3 p-3 bg-gray-50 rounded-xl text-xs space-y-1';
    legend.innerHTML = `
        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-100 border border-red-200 rounded"></div><span class="text-gray-600">จองแล้ว - จองไม่ได้</span></div>
        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-orange-100 border border-orange-200 rounded"></div><span class="text-gray-600">รอตรวจสอบ - จองไม่ได้</span></div>
        ${isToday ? '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-gray-100 border border-gray-200 rounded"></div><span class="text-gray-600">เวลาผ่านไปแล้ว</span></div>' : ''}
        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-white border border-rose-100 rounded"></div><span class="text-gray-600">ว่าง - จองได้</span></div>
    `;
    container.appendChild(legend);
}

// Submit Booking
function handleBooking(e) {
    e.preventDefault();
    const timeInput = document.getElementById('selectedTimeInput');
    if(!timeInput.value) return Swal.fire({icon:'warning', title:'กรุณาเลือกเวลา', confirmButtonColor:'#f43f5e'});
    
    if (!shopStatus.isOpen) {
        const selectedDate = document.getElementById('dateInput').value;
        const todaySpecial = shopStatus.specialDates.find(d => d.date === selectedDate && d.status === 'open');
        if (!todaySpecial) {
            return Swal.fire({ icon: 'error', title: 'ร้านปิดรับจอง', html: 'ขออภัย ขณะนี้ร้านปิดรับจองชั่วคราว', confirmButtonColor: '#f43f5e' });
        }
    }
    
    const selectedDate = document.getElementById('dateInput').value;
    const todaySpecial = shopStatus.specialDates.find(d => d.date === selectedDate);
    if (todaySpecial && todaySpecial.status === 'closed') {
        return Swal.fire({ icon: 'error', title: 'ร้านปิดในวันนี้', html: `ขออภัย ร้านปิดในวันที่เลือก<br><b>${todaySpecial.note}</b>`, confirmButtonColor: '#f43f5e' });
    }
    
    const btn = document.getElementById('submitBtn'); 
    const oldTxt = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> กำลังจอง...';
    
    const f = document.getElementById('bookingForm');
    const addons = [];
    document.querySelectorAll('.addon-checkbox:checked').forEach(cb => addons.push(cb.value));
    
    const data = {
        service: f.service.value, 
        extension: addons.join(', ') || '-', 
        removal: '-', 
        art: f.art.value, 
        shape: f.shape.value, 
        date: f.date.value, 
        time: f.time.value,
        name: f.name.value, 
        phone: f.phone.value, 
        locationType: f.locationType.value,
        address: f.address ? f.address.value : '', 
        price: document.getElementById('totalPriceDisplay').textContent,
        details: f.art.value 
    };

    googleScriptRun.submitBooking(data, res => {
        btn.disabled = false; 
        btn.innerHTML = oldTxt;
        if(res.status === 'success') {
            const calLink = buildCalendarLink(data.service, data.date, data.time, res.orderId, data.phone, data.price);
            Swal.fire({
                icon:'success', 
                title:'จองสำเร็จ!', 
                html:`รหัส: <b>${res.orderId}</b><br><br>
                    <a href="${calLink}" target="_blank" class="inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-blue-600 transition shadow-md">
                        <i class="fas fa-calendar-plus"></i> เพิ่มเข้าปฏิทิน Google
                    </a><br><br>
                    <span class="text-gray-400 text-xs">แคปหน้าจอไว้นะคะ</span>`, 
                confirmButtonColor:'#f43f5e'
            })
            .then(() => { 
                f.reset(); 
                document.getElementById('totalPriceDisplay').textContent = "0"; 
                switchTab('search');
                document.getElementById('search-key').value = res.orderId;
                doSearch();
            });
        } else {
            Swal.fire({ icon: 'error', title: 'ไม่สามารถจองได้', html: res.message, confirmButtonColor: '#f43f5e' })
            .then(() => {
                if (document.getElementById('dateInput').value) {
                    fetchAvailableSlots(document.getElementById('dateInput').value);
                }
            });
        }
    }, err => { 
        btn.disabled = false; 
        btn.innerHTML = oldTxt; 
        Swal.fire('Error', 'Connection Failed', 'error'); 
    });
}

// Search
function doSearch() {
    const key = document.getElementById('search-key').value;
    if(!key) return;
    const resDiv = document.getElementById('search-result');
    const errDiv = document.getElementById('search-error');
    resDiv.innerHTML = '<div class="text-center text-rose-400"><i class="fas fa-circle-notch fa-spin"></i> กำลังค้นหา...</div>';
    resDiv.classList.remove('hidden'); 
    errDiv.classList.add('hidden');

    googleScriptRun.searchBooking(key, res => {
        if(res.status === 'found') {
            const d = res.data;
            let stColor = 'bg-yellow-100 text-yellow-600';
            if(d.status === 'ยืนยันแล้ว') stColor = 'bg-green-100 text-green-600';
            if(d.status === 'ยกเลิก') stColor = 'bg-red-100 text-red-600';
            let dateDisplay = d.date;
            try { dateDisplay = new Date(d.date).toLocaleDateString('th-TH'); } catch(e){}

            resDiv.innerHTML = `
                <div class="bg-white border border-rose-100 rounded-xl p-4 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold rounded-bl-xl ${stColor}">${d.status}</div>
                    <div class="text-xs text-gray-400 mb-1">#${d.orderId}</div>
                    <h3 class="font-bold text-rose-600 text-lg mb-2">${d.service}</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div><i class="far fa-calendar w-5 text-rose-400"></i> ${dateDisplay}</div>
                        <div><i class="far fa-clock w-5 text-rose-400"></i> ${d.time}</div>
                        <div><i class="fas fa-map-marker-alt w-5 text-rose-400"></i> ${d.location}</div>
                        <div><i class="fas fa-tag w-5 text-rose-400"></i> ${d.price} บาท</div>
                    </div>
                    ${d.status !== 'ยกเลิก' ? `
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <a href="${buildCalendarLink(d.service, d.date, d.time, d.orderId, '', d.price)}" target="_blank" 
                           class="flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 rounded-xl text-sm font-medium hover:bg-blue-100 transition border border-blue-200">
                            <i class="fas fa-calendar-plus"></i> เพิ่มเข้าปฏิทิน Google
                        </a>
                    </div>` : ''}
                </div>`;
        } else { resDiv.innerHTML = ''; errDiv.classList.remove('hidden'); }
    });
}

// Admin Functions
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    ['booking', 'search', 'admin'].forEach(p => {
        const el = document.getElementById(`page-${p}`);
        if(p === tab) el.classList.remove('hidden');
        else el.classList.add('hidden');
    });
}

function doLogin() {
    const p = document.getElementById('admin-pass').value;
    googleScriptRun.adminLogin(p, res => {
        if(res.status === 'success') {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('admin-dash').classList.remove('hidden');
            loadAdminData();
            loadDashboardStats();
        } else Swal.fire('Error', 'รหัสผ่านไม่ถูกต้อง', 'error');
    });
}

function adminLogout() {
    document.getElementById('admin-dash').classList.add('hidden');
    document.getElementById('admin-login').classList.remove('hidden');
    document.getElementById('admin-pass').value = '';
}

function loadAdminData() {
    const list = document.getElementById('booking-list');
    list.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> โหลดข้อมูล...</div>';
    googleScriptRun.getAdminData(res => {
        settings = res.settings; 
        bookings = res.bookings;
        if(settings.menu_config && settings.menu_config !== "") { 
            try { menuData = JSON.parse(settings.menu_config); } catch(e){} 
        }
        list.innerHTML = '';
        if(bookings.length === 0) { list.innerHTML = '<div class="text-center mt-10 text-gray-400">ไม่มีรายการจอง</div>'; return; }
        bookings.forEach(b => {
            let stColor = 'text-yellow-500';
            if(b.status === 'ยืนยันแล้ว') stColor = 'text-green-500';
            if(b.status === 'ยกเลิก') stColor = 'text-red-500';
            let dateDisplay = b.date;
            try { dateDisplay = new Date(b.date).toLocaleDateString('th-TH'); } catch(e){}
            const item = document.createElement('div');
            item.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative';
            let formattedDate = b.date;
            let formattedTime = b.time;
            try {
                const d = new Date(b.date);
                if (!isNaN(d)) {
                    formattedDate = d.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                }
                if (b.time && b.time.includes('T')) {
                    const t = new Date(b.time);
                    if (!isNaN(t)) {
                        formattedTime = t.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    }
                }
            } catch(e) {}
            let phoneDisplay = String(b.phone || '');
            if (phoneDisplay.length === 9 && !phoneDisplay.startsWith('0')) phoneDisplay = '0' + phoneDisplay;
            
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div><span class="text-xs text-gray-400">#${b.orderId}</span><div class="font-bold text-gray-800">${b.name} <span class="text-xs font-normal text-gray-500">(${phoneDisplay})</span></div></div>
                    <span class="text-xs font-bold ${stColor}">${b.status}</span>
                </div>
                <div class="bg-rose-50 rounded-lg p-2 mb-3 border border-rose-100">
                    <div class="flex items-center justify-center gap-3">
                        <div class="text-center">
                            <div class="text-xs text-rose-400">วันที่</div>
                            <div class="font-bold text-rose-600 text-sm">${formattedDate}</div>
                        </div>
                        <div class="w-px h-8 bg-rose-200"></div>
                        <div class="text-center">
                            <div class="text-xs text-rose-400">เวลา</div>
                            <div class="font-bold text-rose-600 text-sm">${formattedTime}</div>
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mb-3">
                    <div class="flex items-center gap-2"><i class="fas fa-spa text-rose-300"></i> ${b.service}</div>
                    ${b.price ? `<div class="flex items-center gap-2"><i class="fas fa-tag text-rose-300"></i> ${b.price} บาท</div>` : ''}
                </div>
                <div class="flex gap-2 border-t pt-2 mt-2">
                    <button onclick="updateStatus(${b.row}, 'ยืนยันแล้ว')" class="flex-1 py-1.5 text-xs bg-green-50 text-green-600 rounded hover:bg-green-100">ยืนยัน</button>
                    <button onclick="updateStatus(${b.row}, 'ยกเลิก')" class="flex-1 py-1.5 text-xs bg-red-50 text-red-600 rounded hover:bg-red-100">ยกเลิก</button>
                    <button onclick="deleteBooking(${b.row})" class="px-3 py-1.5 text-xs bg-gray-100 text-gray-400 rounded hover:bg-gray-200"><i class="fas fa-trash"></i></button>
                </div>`;
            list.appendChild(item);
        });
    });
}

function updateStatus(row, status) { 
    if(!confirm(`เปลี่ยนสถานะเป็น "${status}" ?`)) return; 
    googleScriptRun.updateBookingStatus(row, status, () => {
        loadAdminData();
        loadDashboardStats();
    }); 
}

function deleteBooking(row) { 
    if(!confirm("ต้องการลบรายการนี้ใช่ไหม?")) return; 
    googleScriptRun.deleteBooking(row, () => {
        loadAdminData();
        loadDashboardStats();
    }); 
}

function showSettingsModal() {
    const container = document.getElementById('settings-form');
    container.innerHTML = '';
    const fields = [
        {k: 'shopName', l: 'ชื่อร้าน'},
        {k: 'timeSlots', l: 'รอบเวลา (คั่นด้วย ,)'},
        {k: 'notifyEmails', l: 'Email แจ้งเตือนช่าง/พนักงาน (คั่นด้วย ,)'},
        {k: 'marqueeText', l: 'ข้อความป้ายวิ่ง'}
    ];
    
    let contactChannels = {};
    try { contactChannels = JSON.parse(settings.contactChannels || '{}'); } catch(e) {}
    
    const contactFields = [
        {k: 'facebook', l: 'Facebook URL', icon: 'fab fa-facebook', color: 'text-[#1877F2]'},
        {k: 'tiktok', l: 'TikTok URL', icon: 'fab fa-tiktok', color: 'text-gray-800'},
        {k: 'phone', l: 'เบอร์โทรศัพท์', icon: 'fas fa-phone', color: 'text-green-500'}
    ];
    
    fields.forEach(f => {
        container.innerHTML += `<div><label class="text-xs font-bold text-gray-500">${f.l}</label><input type="text" id="set-${f.k}" value="${settings[f.k]||''}" class="w-full border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:border-rose-500 outline-none"></div>`;
    });
    
    container.innerHTML += `<div class="border-t pt-3 mt-3"><h4 class="font-bold text-gray-700 text-sm mb-2">ช่องทางติดต่อ</h4></div>`;
    contactFields.forEach(f => {
        container.innerHTML += `<div><label class="text-xs font-medium text-gray-500 flex items-center gap-1"><i class="${f.icon} ${f.color}"></i> ${f.l}</label><input type="text" id="set-contact-${f.k}" value="${contactChannels[f.k]||''}" placeholder="${f.k === 'phone' ? '0812345678' : 'https://...'}" class="w-full border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:border-rose-500 outline-none"></div>`;
    });
    
    document.getElementById('settings-modal').classList.remove('hidden');
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

function saveSettings() {
    const newSet = {};
    document.querySelectorAll('#settings-form input').forEach(inp => { 
        if (inp.id && !inp.id.startsWith('set-contact-')) {
            newSet[inp.id.replace('set-', '')] = inp.value; 
        }
    });
    newSet['menu_config'] = settings.menu_config;
    
    const contactChannels = {};
    const fbEl = document.getElementById('set-contact-facebook');
    const ttEl = document.getElementById('set-contact-tiktok');
    const phEl = document.getElementById('set-contact-phone');
    
    if (fbEl) contactChannels.facebook = fbEl.value || '';
    if (ttEl) contactChannels.tiktok = ttEl.value || '';
    if (phEl) contactChannels.phone = phEl.value || '';
    
    newSet.contactChannels = JSON.stringify(contactChannels);
    
    apiCall('saveSettings', { settings: newSet }, () => {
        closeModal('settings-modal');
        Swal.fire('Saved', 'บันทึกเรียบร้อย', 'success');
        loadAdminData();
        loadContactChannels();
    });
}

function openServiceManager(tab) { 
    switchManagerTab(tab); 
    document.getElementById('service-modal').classList.remove('hidden'); 
}

function closeServiceManager() { 
    closeModal('service-modal'); 
    renderAllSections(); 
}

function switchManagerTab(tab) {
    currentManagerTab = tab;
    document.querySelectorAll('.cat-tab').forEach(b => b.classList.remove('active'));
    document.getElementById(`mgr-tab-${tab}`).classList.add('active');
    renderManagerList();
}

function renderManagerList() {
    const list = document.getElementById('admin-service-list');
    list.innerHTML = '';
    const items = menuData[currentManagerTab] || [];
    if(items.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4">ไม่มีรายการ</div>';
    items.forEach((s) => {
        let iconDisplay = s.icon && (s.icon.startsWith('http') || s.icon.startsWith('data:')) ? `<img src="${s.icon}" class="w-8 h-8 object-cover rounded">` : `<i class="${s.icon||'fas fa-star'}"></i>`;
        let priceDisplay = s.price !== undefined ? `<div class="text-xs text-gray-500">${s.price} บาท</div>` : '';
        list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 mb-2"><div class="flex items-center gap-3 overflow-hidden"><div class="w-8 h-8 flex-shrink-0 bg-white rounded flex items-center justify-center border text-rose-400 text-xs">${iconDisplay}</div><div class="truncate"><div class="font-bold text-sm truncate">${s.name}</div>${priceDisplay}</div></div><div class="flex gap-1"><button onclick="openServiceEdit('${s.id}')" class="w-8 h-8 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"><i class="fas fa-pen text-xs"></i></button><button onclick="deleteService('${s.id}')" class="w-8 h-8 bg-red-100 text-red-600 rounded hover:bg-red-200"><i class="fas fa-trash text-xs"></i></button></div></div>`;
    });
}

function openServiceEdit(id) {
    const modal = document.getElementById('service-edit-modal');
    const title = document.getElementById('svc-form-title');
    document.getElementById('svc-id').value = ''; 
    document.getElementById('svc-name').value = ''; 
    document.getElementById('svc-price').value = ''; 
    document.getElementById('svc-icon').value = '';
    const priceContainer = document.getElementById('field-price-container');
    if(currentManagerTab === 'services' || currentManagerTab === 'addons') priceContainer.classList.remove('hidden'); 
    else priceContainer.classList.add('hidden');
    
    if(id) {
        const s = menuData[currentManagerTab].find(x => x.id === id);
        if(s) { 
            title.innerText = 'แก้ไขรายการ'; 
            document.getElementById('svc-id').value = s.id; 
            document.getElementById('svc-name').value = s.name; 
            if(s.price !== undefined) document.getElementById('svc-price').value = s.price; 
            document.getElementById('svc-icon').value = s.icon || ''; 
        }
    } else title.innerText = 'เพิ่มรายการใหม่';
    modal.classList.remove('hidden');
}

function saveServiceData() {
    const id = document.getElementById('svc-id').value; 
    const name = document.getElementById('svc-name').value; 
    const price = document.getElementById('svc-price').value; 
    const icon = document.getElementById('svc-icon').value;
    if(!name) return Swal.fire('แจ้งเตือน', 'กรุณากรอกชื่อรายการ', 'warning');
    const item = { name, icon };
    if(currentManagerTab === 'services' || currentManagerTab === 'addons') item.price = parseInt(price) || 0;
    if(id) { 
        const idx = menuData[currentManagerTab].findIndex(s => s.id === id); 
        if(idx !== -1) { item.id = id; menuData[currentManagerTab][idx] = item; } 
    } else { 
        item.id = 'i_' + Date.now(); 
        menuData[currentManagerTab].push(item); 
    }
    closeModal('service-edit-modal');
    saveMenuToBackend();
}

function deleteService(id) { 
    if(!confirm('ยืนยันลบรายการนี้?')) return; 
    menuData[currentManagerTab] = menuData[currentManagerTab].filter(s => s.id !== id); 
    saveMenuToBackend(); 
}

function saveMenuToBackend() {
    renderManagerList();
    const newSet = { ...settings };
    newSet['menu_config'] = JSON.stringify(menuData);
    googleScriptRun.saveSettings({ settings: newSet }, () => {
        settings.menu_config = newSet.menu_config;
        renderAllSections();
    });
}

// Real-time Queue
function startQueueRefresh(date) {
    stopQueueRefresh();
    updateQueueStatus(date);
    const today = new Date().toISOString().split('T')[0];
    const isToday = (date === today);
    const refreshInterval = isToday ? 10000 : 60000;
    queueRefreshInterval = setInterval(() => updateQueueStatus(date), refreshInterval);
}

function stopQueueRefresh() {
    if (queueRefreshInterval) {
        clearInterval(queueRefreshInterval);
        queueRefreshInterval = null;
    }
}

function updateQueueStatus(date) {
    if (!date) return;
    apiCall('getBookingsByDate', { date: date }, (res) => {
        if (res.status === 'success') displayQueueStatus(res.data, date);
    });
}

function displayQueueStatus(bookings, date) {
    const queueStatusDiv = document.getElementById('queueStatus');
    const queueInfoDiv = document.getElementById('queueInfo');
    
    if (!bookings || bookings.length === 0) {
        queueStatusDiv.classList.add('hidden');
        return;
    }
    
    queueStatusDiv.classList.remove('hidden');
    
    const timeGroups = {
        'morning': { label: 'เช้า (10:00-12:00)', booked: 0 },
        'afternoon': { label: 'บ่าย (13:00-15:00)', booked: 0 },
        'evening': { label: 'เย็น (16:00-18:00)', booked: 0 }
    };
    
    bookings.forEach(b => {
        const hour = parseInt(b.time.split(':')[0]);
        if (hour >= 10 && hour < 13) timeGroups.morning.booked++;
        else if (hour >= 13 && hour < 16) timeGroups.afternoon.booked++;
        else if (hour >= 16 && hour < 19) timeGroups.evening.booked++;
    });
    
    const slotsPerPeriod = 3;
    let totalBooked = 0;
    let totalAvailable = 0;
    let html = '';
    
    Object.keys(timeGroups).forEach(key => {
        const group = timeGroups[key];
        const available = Math.max(0, slotsPerPeriod - group.booked);
        totalBooked += group.booked;
        totalAvailable += available;
        
        if (group.booked > 0) {
            const percentBooked = (group.booked / slotsPerPeriod) * 100;
            let statusColor = 'bg-green-400';
            let statusText = 'ว่าง';
            if (percentBooked >= 100) { statusColor = 'bg-red-400'; statusText = 'เต็ม'; }
            else if (percentBooked >= 50) { statusColor = 'bg-yellow-400'; statusText = 'เหลือน้อย'; }
            
            html += `<div class="flex items-center justify-between bg-white rounded-lg p-2 shadow-sm">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${statusColor}"></div><span class="text-sm text-gray-700">${group.label}</span></div>
                <div class="text-right"><span class="text-sm font-bold text-rose-600">${group.booked}/${slotsPerPeriod}</span><span class="text-xs text-gray-400 ml-1">${statusText}</span></div>
            </div>`;
        }
    });
    
    if (html === '') html = '<div class="text-center text-gray-400 text-sm py-2">ยังไม่มีการจองในวันนี้</div>';
    
    queueInfoDiv.innerHTML = html;
    document.getElementById('bookedCount').textContent = totalBooked + ' คน';
    document.getElementById('availableCount').textContent = totalAvailable + ' คน';
    lastQueueData = bookings;
}

// Shop Status
function loadShopStatus() {
    apiCall('getShopStatus', {}, (res) => {
        if (res.status === 'success') {
            shopStatus = res.data;
            updateShopStatusUI();
            updateAdminShopStatusUI();
        }
    });
}

function updateShopStatusUI() {
    const badge = document.getElementById('shopStatusBadge');
    const openDiv = document.getElementById('shopStatusOpen');
    const closedDiv = document.getElementById('shopStatusClosed');
    
    if (badge) {
        badge.classList.remove('hidden');
        if (shopStatus.isOpen) { openDiv.classList.remove('hidden'); closedDiv.classList.add('hidden'); }
        else { openDiv.classList.add('hidden'); closedDiv.classList.remove('hidden'); }
    }
}

function toggleShopStatus() {
    const toggle = document.getElementById('shopStatusToggle');
    const newStatus = toggle.checked;
    apiCall('setShopStatus', { isOpen: newStatus }, (res) => {
        if (res.status === 'success') {
            shopStatus.isOpen = newStatus;
            updateAdminShopStatusUI();
            updateShopStatusUI();
            Swal.fire({ icon: 'success', title: newStatus ? 'เปิดรับจองแล้ว' : 'ปิดรับจองแล้ว', timer: 1500, showConfirmButton: false });
        }
    });
}

function updateAdminShopStatusUI() {
    const badge = document.getElementById('shopStatusAdminBadge');
    const toggle = document.getElementById('shopStatusToggle');
    
    if (shopStatus.isOpen) {
        badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600';
        badge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> เปิดรับจอง';
    } else {
        badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600';
        badge.innerHTML = '<i class="fas fa-times-circle mr-1"></i> ปิดรับจอง';
    }
    if (toggle) toggle.checked = shopStatus.isOpen;
}

function showShopScheduleModal() {
    loadSpecialDates();
    document.getElementById('shop-schedule-modal').classList.remove('hidden');
}

function loadSpecialDates() {
    apiCall('getSpecialDates', {}, (res) => {
        if (res.status === 'success') {
            shopStatus.specialDates = res.data;
            renderSpecialDatesList();
        }
    });
}

function renderSpecialDatesList() {
    const container = document.getElementById('specialDatesList');
    if (shopStatus.specialDates.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">ไม่มีวันที่กำหนดไว้</p>';
        return;
    }
    container.innerHTML = shopStatus.specialDates.map((date, index) => `
        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
            <div class="flex items-center gap-2">
                <i class="fas ${date.status === 'closed' ? 'fa-door-closed text-red-500' : 'fa-door-open text-green-500'}"></i>
                <div>
                    <div class="text-sm font-medium">${new Date(date.date).toLocaleDateString('th-TH')}</div>
                    <div class="text-xs text-gray-500">${date.note || (date.status === 'closed' ? 'ปิดร้าน' : 'เปิดร้าน')}</div>
                </div>
            </div>
            <button onclick="removeSpecialDate(${index})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash-alt"></i></button>
        </div>
    `).join('');
}

function addSpecialDate() {
    const dateInput = document.getElementById('specialDateInput');
    const statusInput = document.getElementById('specialDateStatus');
    const noteInput = document.getElementById('specialDateNote');
    
    if (!dateInput.value) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกวันที่', 'warning'); return; }
    
    const newDate = { date: dateInput.value, status: statusInput.value, note: noteInput.value || (statusInput.value === 'closed' ? 'ปิดร้าน' : 'เปิดร้านพิเศษ') };
    
    apiCall('addSpecialDate', { date: newDate }, (res) => {
        if (res.status === 'success') {
            dateInput.value = '';
            noteInput.value = '';
            loadSpecialDates();
            Swal.fire('สำเร็จ', 'เพิ่มวันพิเศษเรียบร้อย', 'success');
        }
    });
}

function removeSpecialDate(index) {
    if (!confirm('ต้องการลบวันนี้ใช่ไหม?')) return;
    apiCall('removeSpecialDate', { index: index }, (res) => {
        if (res.status === 'success') loadSpecialDates();
    });
}

// Dashboard Stats
function loadDashboardStats() {
    const errorDiv = document.getElementById('admin-dash-error');
    if (errorDiv) errorDiv.classList.add('hidden');

    apiCall('getDashboardStats', {}, (res) => {
        if (res.status === 'success') {
            const d = res.data;
            document.getElementById('today-revenue').textContent = '฿' + d.today.revenue.toLocaleString();
            document.getElementById('month-revenue').textContent = '฿' + d.month.revenue.toLocaleString();
            const totalRevEl = document.getElementById('total-revenue');
            if (totalRevEl) totalRevEl.textContent = '฿' + (d.total ? d.total.revenue : 0).toLocaleString();
            document.getElementById('pending-count').textContent = d.pending;
            
            const badge = document.getElementById('pending-badge');
            if (d.pending > 0) { badge.textContent = d.pending; badge.classList.remove('hidden'); }
            else badge.classList.add('hidden');

            // Render 7-Day Chart
            const chartDiv = document.getElementById('admin-revenue-chart');
            if (chartDiv && d.chart7Days) {
                let maxRev = Math.max(...d.chart7Days.map(item => item.revenue), 100);
                chartDiv.innerHTML = d.chart7Days.map(item => {
                    const height = (item.revenue / maxRev) * 100;
                    return `<div class="flex-1 flex flex-col items-center group relative h-full justify-end">
                        <div class="w-full bg-rose-400 rounded-t-sm transition-all hover:bg-rose-500" style="height: ${Math.max(5, height)}%">
                            <div class="hidden group-hover:block absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10">฿${item.revenue.toLocaleString()}</div>
                        </div>
                        <div class="text-[9px] text-gray-400 mt-1 font-medium">${item.label}</div>
                    </div>`;
                }).join('');
            }

            // Render Top Services
            const serviceDiv = document.getElementById('top-services-list');
            if (serviceDiv && d.topServices) {
                serviceDiv.innerHTML = d.topServices.length ? d.topServices.map((s, idx) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="flex items-center gap-2">
                            <span class="w-5 h-5 flex items-center justify-center bg-rose-500 text-white text-[10px] rounded-full font-bold">${idx+1}</span>
                            <span class="text-gray-700 truncate w-24 sm:w-auto font-medium">${s.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">${s.count} คิว</div>
                            <div class="text-[10px] text-gray-400">฿${s.revenue.toLocaleString()}</div>
                        </div>
                    </div>
                `).join('') : '<p class="text-center text-gray-400 py-4">ยังไม่มีข้อมูลบริการ</p>';
            }

            // Render Staff Stats
            const staffDiv = document.getElementById('staff-stats-list');
            if (staffDiv && d.byStaff) {
                staffDiv.innerHTML = d.byStaff.length ? d.byStaff.map(s => `
                    <div class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-sm shadow-inner">${s.name[0]}</div>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                                <div class="text-[10px] text-gray-400">สรุปงานสะสม</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div class="bg-blue-50/50 p-2 rounded-lg">
                                <div class="text-[10px] text-gray-400">งานสำเร็จ</div>
                                <div class="font-bold text-blue-600">${s.count} คิว</div>
                            </div>
                            <div class="bg-green-50/50 p-2 rounded-lg">
                                <div class="text-[10px] text-gray-400">รายได้รวม</div>
                                <div class="font-bold text-green-600">฿${s.revenue.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p class="text-center text-gray-400 py-4 col-span-full">ยังไม่มีข้อมูลช่าง</p>';
            }
        } else {
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ไม่สามารถดึงข้อมูลได้: ${res.message || 'Unknown error'}`;
            }
        }
    }, (err) => {
        if (errorDiv) {
            errorDiv.classList.remove('hidden');
            errorDiv.innerHTML = `<i class="fas fa-wifi-slash mr-2"></i> การดึงข้อมูลล้มเหลว ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต`;
        }
    });
}

function showPendingApprovals() {
    const list = document.getElementById('booking-list');
    list.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> โหลดข้อมูล...</div>';
    
    apiCall('getAdminData', {}, (res) => {
        const pending = res.bookings.filter(b => b.status === 'แจ้งชำระแล้ว');
        if (pending.length === 0) { list.innerHTML = '<div class="text-center mt-10 text-gray-400">ไม่มีรายการรออนุมัติ</div>'; return; }
        
        list.innerHTML = '<h4 class="font-bold text-orange-500 mb-3">รอการอนุมัติ (' + pending.length + ')</h4>';
        pending.forEach(b => {
            let formattedDate = b.date;
            let formattedTime = b.time;
            try {
                const d = new Date(b.date);
                if (!isNaN(d)) {
                    formattedDate = d.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                }
                if (b.time && b.time.includes('T')) {
                    const t = new Date(b.time);
                    if (!isNaN(t)) {
                        formattedTime = t.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    }
                }
            } catch(e) {}
            const item = document.createElement('div');
            item.className = 'bg-orange-50 p-4 rounded-xl shadow-sm border border-orange-200 relative';
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div><span class="text-xs text-gray-400">#${b.orderId}</span><div class="font-bold text-gray-800">${b.name}</div></div>
                    <span class="text-xs font-bold text-orange-500">รอตรวจสอบ</span>
                </div>
                <div class="bg-white rounded-lg p-2 mb-3 border border-orange-100">
                    <div class="flex items-center justify-center gap-3">
                        <div class="text-center">
                            <div class="text-xs text-orange-400">วันที่</div>
                            <div class="font-bold text-orange-600 text-sm">${formattedDate}</div>
                        </div>
                        <div class="w-px h-8 bg-orange-200"></div>
                        <div class="text-center">
                            <div class="text-xs text-orange-400">เวลา</div>
                            <div class="font-bold text-orange-600 text-sm">${formattedTime}</div>
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mb-3">
                    <div class="flex items-center gap-2"><i class="fas fa-spa text-orange-400"></i> ${b.service}</div>
                    <div class="flex items-center gap-2"><i class="fas fa-tag text-orange-400"></i> ${b.price} บาท</div>
                </div>
                <div class="flex gap-2">
                    ${b.slipUrl ? `<button onclick="viewPaymentSlip('${b.slipUrl}', ${b.row})" class="flex-1 py-1.5 text-xs bg-blue-100 text-blue-600 rounded">ดูสลิป</button>` : ''}
                    <button onclick="approveBookingWithSlip(${b.row})" class="flex-1 py-1.5 text-xs bg-green-100 text-green-600 rounded">อนุมัติ</button>
                    <button onclick="rejectBooking(${b.row})" class="flex-1 py-1.5 text-xs bg-red-100 text-red-600 rounded">ปฏิเสธ</button>
                </div>
            `;
            list.appendChild(item);
        });
    });
}

function viewPaymentSlip(slipUrl, row) {
    currentSlipRow = row;
    document.getElementById('slip-image').src = slipUrl || '';
    document.getElementById('slip-modal').classList.remove('hidden');
}

function approveBookingWithSlip(row) {
    if (!confirm('ยืนยันการอนุมัติคิวนี้?')) return;
    apiCall('updateBookingStatus', { rowIndex: row, status: 'ยืนยันแล้ว' }, () => {
        Swal.fire('สำเร็จ', 'อนุมัติคิวเรียบร้อย', 'success');
        loadAdminData();
        loadDashboardStats();
    });
}

function approveWithSlip() {
    if (currentSlipRow) {
        approveBookingWithSlip(currentSlipRow);
        closeModal('slip-modal');
    }
}

function rejectWithSlip() {
    if (currentSlipRow) {
        const reason = prompt('เหตุผลในการปฏิเสธ:');
        if (reason) {
            updateStatus(currentSlipRow, 'ยกเลิก');
            closeModal('slip-modal');
        }
    }
}

function rejectBooking(row) {
    if (!confirm('ต้องการปฏิเสธคิวนี้?')) return;
    updateStatus(row, 'ยกเลิก');
}

// CRM
function showCustomersPage() {
    const list = document.getElementById('booking-list');
    list.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> โหลดข้อมูล...</div>';
    apiCall('getCustomers', { limit: 50 }, (res) => {
        if (res.data.length === 0) { list.innerHTML = '<div class="text-center mt-10 text-gray-400">ไม่มีข้อมูลลูกค้า</div>'; return; }
        list.innerHTML = `<div class="flex justify-between items-center mb-4"><h4 class="font-bold text-gray-700">รายชื่อลูกค้า</h4></div><div id="customers-list" class="space-y-3"></div>`;
        renderCustomersList(res.data);
    });
}

function renderCustomersList(customers) {
    const container = document.getElementById('customers-list');
    container.innerHTML = '';
    customers.forEach(c => {
        const item = document.createElement('div');
        item.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition';
        item.onclick = () => showCustomerDetail(c.id);
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div><div class="font-bold text-gray-800">${c.name}</div><div class="text-sm text-gray-500">${c.phone}</div></div>
                <div class="text-right"><div class="text-xs text-gray-400">เข้ารับบริการ</div><div class="font-bold text-rose-500">${c.totalVisits} ครั้ง</div></div>
            </div>
        `;
        container.appendChild(item);
    });
}

function showCustomerDetail(customerId) {
    apiCall('getCustomerProfile', { customerId: customerId }, (res) => {
        const c = res.data;
        const content = document.getElementById('customer-detail-content');
        content.innerHTML = `
            <div class="text-center mb-4">
                <div class="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-user text-3xl text-rose-400"></i></div>
                <h4 class="font-bold text-lg">${c.name}</h4>
                <p class="text-gray-500 text-sm">${c.phone}</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                <div><label class="text-xs text-gray-400">สภาพผม</label><p class="font-medium">${c.hairType || 'ไม่ระบุ'}</p></div>
                ${c.allergies ? `<div class="bg-red-50 p-3 rounded-lg"><label class="text-xs text-red-400"><i class="fas fa-exclamation-triangle mr-1"></i>การแพ้</label><p class="text-red-600 text-sm">${c.allergies}</p></div>` : ''}
                <div><label class="text-xs text-gray-400">ประวัติ</label><p class="text-sm">${c.history || 'ไม่มีข้อมูล'}</p></div>
            </div>
            <div class="flex gap-2 mt-4">
                <div class="flex-1 bg-rose-50 p-3 rounded-xl text-center"><div class="text-2xl font-bold text-rose-500">${c.totalVisits}</div><div class="text-xs text-gray-500">ครั้งที่มา</div></div>
                <div class="flex-1 bg-green-50 p-3 rounded-xl text-center"><div class="text-2xl font-bold text-green-500">฿${(c.totalSpent || 0).toLocaleString()}</div><div class="text-xs text-gray-500">ยอดรวม</div></div>
            </div>
        `;
        document.getElementById('customer-modal').classList.remove('hidden');
    });
}

// Reports
function showReportsPage() {
    document.getElementById('reports-modal').classList.remove('hidden');
    loadRevenueReport('today');
}

function loadRevenueReport(period) {
    let startDate, endDate;
    const today = new Date().toISOString().split('T')[0];
    
    if (period === 'today') { startDate = today; endDate = today; }
    else if (period === 'week') { startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; endDate = today; }
    else { startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; endDate = today; }
    
    apiCall('getRevenueReport', { startDate, endDate, groupBy: 'day' }, (res) => {
        const chartDiv = document.getElementById('revenue-chart');
        const summaryDiv = document.getElementById('revenue-summary');
        
        if (res.data.length === 0) { chartDiv.innerHTML = '<p class="text-gray-400 text-sm">ไม่มีข้อมูล</p>'; summaryDiv.innerHTML = ''; return; }
        
        let maxRevenue = Math.max(...res.data.map(d => d.revenue));
        let chartHtml = '<div class="flex items-end justify-between h-full px-2 gap-1">';
        res.data.forEach(d => {
            const height = maxRevenue > 0 ? (d.revenue / maxRevenue * 100) : 0;
            chartHtml += `<div class="flex-1 flex flex-col items-center"><div class="w-full bg-rose-400 rounded-t" style="height: ${height}%"></div><div class="text-[10px] text-gray-500 mt-1">${d.date.substring(5)}</div></div>`;
        });
        chartHtml += '</div>';
        chartDiv.innerHTML = chartHtml;
        
        const totalRevenue = res.data.reduce((sum, d) => sum + d.revenue, 0);
        const totalCount = res.data.reduce((sum, d) => sum + d.count, 0);
        summaryDiv.innerHTML = `
            <div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-sm text-gray-600">รายได้รวม</span><span class="text-lg font-bold text-rose-500">฿${totalRevenue.toLocaleString()}</span></div></div>
            <div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-sm text-gray-600">จำนวนรายการ</span><span class="text-lg font-bold text-blue-500">${totalCount} รายการ</span></div></div>
        `;
    });
}

function buildCalendarLink(service, date, time, orderId, phone, price) {
    const timeParts = time.split(':');
    const startHour = timeParts[0].padStart(2, '0');
    const startMin = (timeParts[1] || '00').padStart(2, '0');
    const dateClean = date.replace(/-/g, '');
    const startStr = `${dateClean}T${startHour}${startMin}00`;
    const endH = String(parseInt(startHour) + 1).padStart(2, '0');
    const endStr = `${dateClean}T${endH}${startMin}00`;
    const title = encodeURIComponent(`💅 GY-Nail: ${service}`);
    const details = encodeURIComponent(`รหัสจอง: ${orderId}\nบริการ: ${service}${phone ? '\nเบอร์โทร: ' + phone : ''}\nราคา: ${price} บาท`);
    const location = encodeURIComponent('GY-Nail Shop');
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startStr}/${endStr}&details=${details}&location=${location}&ctz=Asia/Bangkok`;
}

function showPriceList() {
    let html = '<div class="text-left text-sm space-y-2 text-gray-600 max-h-[60vh] overflow-y-auto pr-2">';
    html += `<div class="border-b pb-1 mb-1 font-bold text-rose-500 sticky top-0 bg-white">บริการหลัก</div><ul class="list-disc pl-4 mb-3">`;
    menuData.services.forEach(s => html += `<li>${s.name}: ${s.price}.-</li>`);
    html += `</ul>`;
    html += `<div class="border-b pb-1 mb-1 font-bold text-rose-500 sticky top-0 bg-white">บริการเสริม</div><ul class="list-disc pl-4 mb-3">`;
    menuData.addons.forEach(a => html += `<li>${a.name}: +${a.price}.-</li>`);
    html += `</ul></div>`;
    Swal.fire({ title: 'เรทราคาบริการ', html: html, confirmButtonColor: '#f43f5e' });
}

// ============================================
// AI NAIL CONSULTANT
// ============================================

let aiChatOpen = false;
let aiUnreadCount = 0;
let aiBubbleDragging = false;
let aiBubbleStartX = 0, aiBubbleStartY = 0, aiBubbleOrigX = 0, aiBubbleOrigY = 0;
let aiBubbleMoved = false;

function toggleAIChat() {
    if (aiBubbleMoved) return;
    const panel = document.getElementById('ai-panel');
    aiChatOpen = !aiChatOpen;
    if (aiChatOpen) {
        panel.classList.remove('hidden');
        aiUnreadCount = 0;
        document.getElementById('ai-badge').classList.add('hidden');
        const container = document.getElementById('ai-chat-container');
        container.scrollTop = container.scrollHeight;
        setTimeout(() => document.getElementById('ai-input').focus(), 100);
    } else {
        panel.classList.add('hidden');
    }
}

function addAIUnread() {
    if (!aiChatOpen) {
        aiUnreadCount++;
        const badge = document.getElementById('ai-badge');
        const count = document.getElementById('ai-badge-count');
        count.textContent = aiUnreadCount > 9 ? '9+' : aiUnreadCount;
        badge.classList.remove('hidden');
    }
}

function aiBubbleTouchStart(e) {
    const touch = e.touches[0];
    const bubble = document.getElementById('ai-bubble');
    aiBubbleDragging = true;
    aiBubbleMoved = false;
    aiBubbleStartX = touch.clientX;
    aiBubbleStartY = touch.clientY;
    aiBubbleOrigX = bubble.offsetLeft;
    aiBubbleOrigY = bubble.offsetTop;
    bubble.classList.add('dragging');
    bubble.classList.remove('snapping');
}

function aiBubbleTouchMove(e) {
    if (!aiBubbleDragging) return;
    e.preventDefault();
    const touch = e.touches[0];
    const dx = touch.clientX - aiBubbleStartX;
    const dy = touch.clientY - aiBubbleStartY;
    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) aiBubbleMoved = true;
    const bubble = document.getElementById('ai-bubble');
    const newX = Math.max(0, Math.min(window.innerWidth - 70, aiBubbleOrigX + dx));
    const newY = Math.max(0, Math.min(window.innerHeight - 70, aiBubbleOrigY + dy));
    bubble.style.left = newX + 'px';
    bubble.style.top = newY + 'px';
    bubble.style.right = 'auto';
    bubble.style.bottom = 'auto';
}

function aiBubbleTouchEnd(e) {
    aiBubbleDragging = false;
    const bubble = document.getElementById('ai-bubble');
    bubble.classList.remove('dragging');
    if (aiBubbleMoved) snapBubbleToEdge(bubble);
    setTimeout(() => { aiBubbleMoved = false; }, 50);
}

function aiBubbleMouseDown(e) {
    if (e.button !== 0) return;
    const bubble = document.getElementById('ai-bubble');
    aiBubbleDragging = true;
    aiBubbleMoved = false;
    aiBubbleStartX = e.clientX;
    aiBubbleStartY = e.clientY;
    aiBubbleOrigX = bubble.offsetLeft;
    aiBubbleOrigY = bubble.offsetTop;
    bubble.classList.add('dragging');
    bubble.classList.remove('snapping');

    const onMove = (ev) => {
        if (!aiBubbleDragging) return;
        const dx = ev.clientX - aiBubbleStartX;
        const dy = ev.clientY - aiBubbleStartY;
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) aiBubbleMoved = true;
        const newX = Math.max(0, Math.min(window.innerWidth - 70, aiBubbleOrigX + dx));
        const newY = Math.max(0, Math.min(window.innerHeight - 70, aiBubbleOrigY + dy));
        bubble.style.left = newX + 'px';
        bubble.style.top = newY + 'px';
        bubble.style.right = 'auto';
        bubble.style.bottom = 'auto';
    };
    const onUp = () => {
        aiBubbleDragging = false;
        bubble.classList.remove('dragging');
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (aiBubbleMoved) snapBubbleToEdge(bubble);
        setTimeout(() => { aiBubbleMoved = false; }, 50);
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
}

function snapBubbleToEdge(bubble) {
    bubble.classList.add('snapping');
    const rect = bubble.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    if (centerX < window.innerWidth / 2) {
        bubble.style.left = '10px';
        bubble.style.right = 'auto';
    } else {
        bubble.style.left = 'auto';
        bubble.style.right = '10px';
    }
}

let aiContext = { nailCondition: '', preferredStyle: '' };

function setAIContext(type) {
    const input = document.getElementById('ai-input');
    if (type === 'dry') {
        aiContext.nailCondition = 'แห้ง/เปราะ';
        input.value = 'เล็บแห้งเปราะมาก ดูแลยังไงดีคะ';
    } else if (type === 'design') {
        aiContext.preferredStyle = 'Minimal';
        input.value = 'แนะนำลายเล็บแบบ Minimal หน่อยค่ะ';
    } else if (type === 'care') {
        input.value = 'ดูแลเล็บยังไงให้แข็งแรงคะ';
    }
    input.focus();
}

function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat('user', message);
    input.value = '';
    
    // Show typing indicator
    const typingId = showTypingIndicator();
    
    // Call AI API
    apiCall('getAIAdvice', {
        question: message,
        nailCondition: aiContext.nailCondition,
        preferredStyle: aiContext.preferredStyle
    }, (res) => {
        removeTypingIndicator(typingId);
        if (res.status === 'success') {
            addMessageToChat('ai', res.data.advice);
            addAIUnread();
        } else {
            addMessageToChat('ai', 'ขออภัยนะคะ น้องยุ้ยไม่เข้าใจคำถาม ลองถามใหม่อีกครั้งนะคะ');
            addAIUnread();
        }
    }, () => {
        removeTypingIndicator(typingId);
        addMessageToChat('ai', 'ขออภัยค่ะ ระบบขัดข้องชั่วคราว ลองใหม่อีกครั้งนะคะ');
        addAIUnread();
    });
}

function addMessageToChat(sender, message) {
    const container = document.getElementById('ai-chat-container');
    const isAI = sender === 'ai';
    
    const html = `
        <div class="flex gap-3 ${isAI ? '' : 'flex-row-reverse'}">
            <div class="w-8 h-8 ${isAI ? 'bg-rose-500' : 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas ${isAI ? 'fa-robot' : 'fa-user'} text-white text-xs"></i>
            </div>
            <div class="${isAI ? 'bg-white' : 'bg-rose-100'} p-3 rounded-2xl ${isAI ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm max-w-[80%]">
                <p class="text-sm text-gray-700 whitespace-pre-line">${message}</p>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
    const container = document.getElementById('ai-chat-container');
    const id = 'typing-' + Date.now();
    const html = `
        <div id="${id}" class="flex gap-3">
            <div class="w-8 h-8 bg-rose-500 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-xs"></i>
            </div>
            <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
    return id;
}

function removeTypingIndicator(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}

// ============================================
// REVIEWS SYSTEM
// ============================================

let currentRating = 0;

function showReviews() {
    document.getElementById('reviews-modal').classList.remove('hidden');
    loadReviews();
}

function loadReviews() {
    apiCall('getReviews', { status: 'approved', limit: 10 }, (res) => {
        if (res.status === 'success') {
            // Update summary
            document.getElementById('avg-rating').textContent = res.summary.average;
            document.getElementById('total-reviews').textContent = res.summary.total;
            
            // Render stars
            const avgStars = Math.round(res.summary.average);
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="fas fa-star ${i <= avgStars ? 'text-yellow-400' : 'text-gray-300'}"></i>`;
            }
            document.getElementById('avg-stars').innerHTML = starsHtml;
            
            // Render reviews
            const container = document.getElementById('reviews-list');
            if (res.data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">ยังไม่มีรีวิว</p>';
                return;
            }
            
            container.innerHTML = res.data.map(r => {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += `<i class="fas fa-star ${i <= r.rating ? 'text-yellow-400' : 'text-gray-200'} text-xs"></i>`;
                }
                const date = new Date(r.date).toLocaleDateString('th-TH');
                return `
                    <div class="bg-gray-50 p-3 rounded-xl">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-medium text-sm">${r.customerName}</div>
                                <div class="flex gap-0.5 mt-0.5">${stars}</div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                        <p class="text-sm text-gray-600">${r.review || 'ไม่มีความคิดเห็น'}</p>
                    </div>
                `;
            }).join('');
        }
    });
}

function showSubmitReview() {
    document.getElementById('submit-review-modal').classList.remove('hidden');
}

function setRating(rating) {
    currentRating = rating;
    document.getElementById('review-rating').value = rating;
    document.querySelectorAll('.star-btn').forEach(btn => {
        const btnRating = parseInt(btn.dataset.rating);
        if (btnRating <= rating) {
            btn.classList.remove('text-gray-300');
            btn.classList.add('text-yellow-400');
        } else {
            btn.classList.remove('text-yellow-400');
            btn.classList.add('text-gray-300');
        }
    });
}

function submitReview() {
    const orderId = document.getElementById('review-order-id').value.trim();
    const rating = parseInt(document.getElementById('review-rating').value);
    const review = document.getElementById('review-text').value.trim();
    const imageFile = document.getElementById('review-image').files[0];
    
    if (!orderId) return Swal.fire('แจ้งเตือน', 'กรุณาระบุรหัสการจอง', 'warning');
    if (rating === 0) return Swal.fire('แจ้งเตือน', 'กรุณาให้คะแนน', 'warning');
    
    const doSubmit = (imageUrl) => {
        apiCall('submitReview', { orderId, rating, review, customerName: 'ลูกค้า', imageUrl: imageUrl || '' }, (res) => {
            if (res.status === 'success') {
                Swal.fire('สำเร็จ', 'ขอบคุณสำหรับรีวิวค่ะ', 'success');
                closeModal('submit-review-modal');
                document.getElementById('review-order-id').value = '';
                document.getElementById('review-text').value = '';
                document.getElementById('review-image').value = '';
                setRating(0);
            } else {
                Swal.fire('แจ้งเตือน', res.message, 'warning');
            }
        });
    };
    
    if (imageFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            fetch(`${API_URL}?action=uploadImage`, {
                method: "POST",
                body: JSON.stringify({
                    base64: e.target.result,
                    fileName: imageFile.name,
                    mimeType: imageFile.type,
                    folder: 'REVIEWS',
                    orderId: orderId
                }),
                redirect: "follow",
                mode: "no-cors"
            }).then(() => {
                setTimeout(() => doSubmit('uploaded'), 2000);
            }).catch(() => doSubmit(''));
        };
        reader.readAsDataURL(imageFile);
    } else {
        doSubmit('');
    }
}

function showReviewManagement() {
    // For admin - load all reviews including pending
    apiCall('getReviews', { status: 'all', limit: 50 }, (res) => {
        const list = document.getElementById('booking-list');
        if (res.data.length === 0) {
            list.innerHTML = '<div class="text-center mt-10 text-gray-400">ไม่มีรีวิว</div>';
            return;
        }
        
        list.innerHTML = '<h4 class="font-bold text-gray-700 mb-3">จัดการรีวิว (' + res.data.length + ')</h4>';
        
        res.data.forEach(r => {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fas fa-star ${i <= r.rating ? 'text-yellow-400' : 'text-gray-200'} text-xs"></i>`;
            }
            const statusColor = r.status === 'approved' ? 'text-green-500' : (r.status === 'pending' ? 'text-yellow-500' : 'text-red-500');
            
            const item = document.createElement('div');
            item.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100';
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-bold text-gray-800">${r.customerName}</div>
                        <div class="flex gap-0.5 mt-0.5">${stars}</div>
                    </div>
                    <span class="text-xs font-bold ${statusColor}">${r.status}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">${r.review || 'ไม่มีความคิดเห็น'}</p>
                ${r.status === 'pending' ? `
                    <div class="flex gap-2">
                        <button onclick="approveReview('${r.orderId}')" class="flex-1 py-1.5 text-xs bg-green-50 text-green-600 rounded">อนุมัติ</button>
                        <button onclick="rejectReview('${r.orderId}')" class="flex-1 py-1.5 text-xs bg-red-50 text-red-600 rounded">ปฏิเสธ</button>
                    </div>
                ` : ''}
            `;
            list.appendChild(item);
        });
    });
}

function approveReview(orderId) {
    apiCall('updateReviewStatus', { orderId, status: 'approved' }, () => {
        Swal.fire('สำเร็จ', 'อนุมัติรีวิวเรียบร้อย', 'success');
        showReviewManagement();
    });
}

function rejectReview(orderId) {
    apiCall('updateReviewStatus', { orderId, status: 'rejected' }, () => {
        showReviewManagement();
    });
}

// ============================================
// PORTFOLIO & DRIVE GALLERY
// ============================================

let isAdminPortfolio = false;

function showPortfolioGallery() {
    isAdminPortfolio = false;
    document.getElementById('portfolio-upload-section').classList.add('hidden');
    document.getElementById('portfolio-modal').classList.remove('hidden');
    loadPortfolioImages();
}

function showPortfolioManager() {
    isAdminPortfolio = true;
    document.getElementById('portfolio-upload-section').classList.remove('hidden');
    document.getElementById('portfolio-modal').classList.remove('hidden');
    loadPortfolioImages();
}

function loadPortfolioImages() {
    const grid = document.getElementById('portfolio-grid');
    grid.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-circle-notch fa-spin"></i> กำลังโหลด...</div>';
    
    apiCall('getPortfolio', {}, (res) => {
        if (res.status === 'success') {
            if (res.data.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-images text-4xl mb-3 block"></i>ยังไม่มีรูปผลงาน</div>';
                return;
            }
            grid.innerHTML = '<div class="grid grid-cols-2 sm:grid-cols-3 gap-3">' +
                res.data.map(p => `
                    <div class="relative group rounded-xl overflow-hidden shadow-sm border border-gray-100">
                        <img src="${p.thumb}" class="w-full aspect-square object-cover cursor-pointer hover:scale-105 transition" 
                             onclick="document.getElementById('preview-image').src='${p.url}'; document.getElementById('image-preview-modal').classList.remove('hidden');"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%239ca3af%22 font-size=%2214%22>No Image</text></svg>'">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
                            <p class="text-white text-xs font-medium truncate">${p.caption || ''}</p>
                            ${p.category ? `<span class="text-[10px] bg-white/30 text-white px-1.5 py-0.5 rounded-full">${p.category}</span>` : ''}
                        </div>
                        ${isAdminPortfolio ? `<button onclick="event.stopPropagation(); deletePortfolioImage('${p.id}')" class="absolute top-2 right-2 w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg"><i class="fas fa-trash text-xs"></i></button>` : ''}
                    </div>
                `).join('') + '</div>';
        }
    });
}

function uploadPortfolioImage() {
    const fileInput = document.getElementById('portfolio-file');
    const caption = document.getElementById('portfolio-caption').value;
    const category = document.getElementById('portfolio-category').value;
    
    if (!fileInput.files[0]) return Swal.fire('แจ้งเตือน', 'กรุณาเลือกรูปภาพ', 'warning');
    if (fileInput.files[0].size > 5 * 1024 * 1024) return Swal.fire('แจ้งเตือน', 'ไฟล์ใหญ่เกิน 5MB', 'warning');
    
    const btn = document.getElementById('upload-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> กำลังอัพโหลด...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const payload = {
            base64: e.target.result,
            fileName: fileInput.files[0].name,
            mimeType: fileInput.files[0].type,
            folder: 'PORTFOLIO',
            caption: caption,
            category: category
        };
        
        fetch(`${API_URL}?action=uploadImage`, {
            method: "POST",
            body: JSON.stringify(payload),
            redirect: "follow",
            mode: "no-cors"
        }).then(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload mr-1"></i> อัพโหลด';
            Swal.fire({ icon: 'success', title: 'อัพโหลดสำเร็จ!', text: 'รอสักครู่ รูปกำลังประมวลผล...', timer: 2000, showConfirmButton: false });
            fileInput.value = '';
            document.getElementById('portfolio-caption').value = '';
            setTimeout(() => loadPortfolioImages(), 3000);
        }).catch(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload mr-1"></i> อัพโหลด';
            Swal.fire('Error', 'อัพโหลดไม่สำเร็จ ลองใหม่', 'error');
        });
    };
    reader.readAsDataURL(fileInput.files[0]);
}

function deletePortfolioImage(fileId) {
    if (!confirm('ต้องการลบรูปนี้?')) return;
    apiCall('deleteImage', { fileId: fileId }, (res) => {
        if (res.status === 'success') loadPortfolioImages();
        else Swal.fire('Error', res.message, 'error');
    });
}

function openDriveFolder() {
    apiCall('getGalleryFolderInfo', {}, (res) => {
        if (res.status === 'success') window.open(res.folderUrl, '_blank');
        else Swal.fire('Error', 'ไม่สามารถเปิด Drive ได้', 'error');
    });
}

// ============================================
// CONTACT CHANNELS
// ============================================

let contactMenuOpen = false;

function toggleContactMenu() {
    const menu = document.getElementById('contact-menu');
    const bubble = document.getElementById('contact-bubble').querySelector('div:first-child');
    const links = menu.querySelectorAll('a');
    contactMenuOpen = !contactMenuOpen;
    
    if (contactMenuOpen) {
        menu.classList.remove('hidden');
        bubble.style.transform = 'rotate(0deg)';
        links.forEach((link, i) => {
            link.style.animation = 'none';
            link.offsetHeight;
            link.style.animation = `contactPop 0.3s ease forwards ${i * 0.08}s`;
        });
    } else {
        menu.classList.add('hidden');
        bubble.style.transform = 'rotate(-90deg)';
    }
}

function loadContactChannels() {
    apiCall('getSettings', {}, (res) => {
        if (res.status === 'success' && res.data.contactChannels) {
            let channels = res.data.contactChannels;
            if (typeof channels === 'string') {
                try { channels = JSON.parse(channels); } catch(e) { console.error("Error parsing contactChannels", e); return; }
            }
            if (channels.facebook) document.getElementById('contact-facebook').href = channels.facebook;
            if (channels.tiktok) document.getElementById('contact-tiktok').href = channels.tiktok;
            if (channels.phone) document.getElementById('contact-phone').href = 'tel:' + channels.phone;
        }
    });
}

// ============================================
// SNOWFALL EFFECT
// ============================================

let snowCanvas, snowCtx;
let snowflakes = [];
let snowAnimationId;

function initSnowfall() {
    snowCanvas = document.getElementById('snowCanvas');
    if (!snowCanvas) return;
    snowCtx = snowCanvas.getContext('2d');
    if (!snowCtx) return;
    resizeSnowCanvas();
    window.addEventListener('resize', resizeSnowCanvas);
    createSnowflakes();
    animateSnow();
}

function resizeSnowCanvas() {
    if (!snowCanvas) return;
    snowCanvas.width = window.innerWidth;
    snowCanvas.height = window.innerHeight;
}

function createSnowflakes() {
    snowflakes = [];
    const flakeCount = Math.floor(window.innerWidth / 8);
    for (let i = 0; i < flakeCount; i++) {
        snowflakes.push({
            x: Math.random() * snowCanvas.width,
            y: Math.random() * snowCanvas.height,
            r: Math.random() * 3 + 1,
            d: Math.random() * flakeCount,
            speed: Math.random() * 1 + 0.5
        });
    }
}

function animateSnow() {
    snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    snowCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    snowCtx.beginPath();
    
    for (let i = 0; i < snowflakes.length; i++) {
        const flake = snowflakes[i];
        snowCtx.moveTo(flake.x, flake.y);
        snowCtx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2, true);
    }
    snowCtx.fill();
    moveSnowflakes();
    snowAnimationId = requestAnimationFrame(animateSnow);
}

function moveSnowflakes() {
    for (let i = 0; i < snowflakes.length; i++) {
        const flake = snowflakes[i];
        flake.y += flake.speed;
        flake.x += Math.sin(flake.d) * 0.5;
        
        if (flake.y > snowCanvas.height) {
            flake.y = -10;
            flake.x = Math.random() * snowCanvas.width;
        }
        if (flake.x > snowCanvas.width) flake.x = 0;
        if (flake.x < 0) flake.x = snowCanvas.width;
        flake.d += 0.01;
    }
}

function stopSnowfall() {
    if (snowAnimationId) {
        cancelAnimationFrame(snowAnimationId);
        snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    }
}
</script>
</body>
</html>
